<div *ngIf="!elt">
    <h1 class="pt60 pb40 text-center">
        <i class="fa fa-spinner fa-pulse"></i>Loading...
    </h1>
</div>
<div *ngIf="elt?.tinyId" class="container-fluid" itemscope="http://schema.org/MedicalCode">
    <div id="warning">
        <div *ngIf="elt.archived" class="alert alert-warning mt20" role="alert">
            <i class="fa fa-exclamation-triangle"></i>
            <strong>Warning:</strong> this data element is archived. You can
            <a routerLink="/deView" [queryParams]="{tinyId: elt.tinyId}">view the current version here</a>.
        </div>
        <div *ngIf="elt.registrationState.registrationStatus=='Retired'" class="alert alert-warning mt20" role="alert">
            <i class="fa fa-exclamation-triangle"></i>
            <strong>Warning:</strong> this data element is retired.
            <span *ngIf="elt.registrationState.replacedBy">
            <a routerLink="/deView" [queryParams]="{tinyId: elt.registrationState.replacedBy.tinyId}">Replacement</a>
        </span>
        </div>
        <div *ngIf="elt.registrationState.administrativeStatus=='Retire Candidate'" class="alert alert-warning mt20"
             role="alert">
            <i class="fa fa-exclamation-triangle"></i>
            <strong>Warning:</strong> this data element is about to be retired.
            <span *ngIf="elt.registrationState.replacedBy">
            <a routerLink="/deView" [queryParams]="{tinyId: elt.registrationState.replacedBy.tinyId}">Possible Replacement</a>
        </span>
        </div>
        <div *ngIf="displayStatusWarning" class="alert alert-info mt20" role="alert">
            <i class="fa fa-exclamation-triangle"></i>
            <strong>Note:</strong> You may not edit this CDE because it is standard.
        </div>
    </div>
    <h1 class="mobileViewH1 my-4">
        <cde-draft-slider [(isDraft)]="elt.isDraft" (isDraftChange)="$event?loadDraft(null):loadDataElement(null)"
                          [hidden]="drafts?.length === 0"></cde-draft-slider>
        {{elt?.naming[0].designation}}
    </h1>
    <div class="pull-left">
        <div class="dropdown float-left">
            <button id="export" class="btn  btn-outline-dark dropdown-toggle mr-1" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-download mr-1"></i><span class="d-none d-sm-inline-block">Export</span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="export">
                <li class="dropdown-item">
                    <a id='jsonExport' href="deById/{{elt._id}}" target="_blank">
                        JSON File, NIH/CDE Schema</a>
                    <a href="/schema/cde" target="_blank"><i class="fa fa-info-circle"></i></a>
                </li>
                <li class="dropdown-item">
                    <a id='xmlExport' href="deById/{{elt._id}}?type=xml" target="_blank">
                        XML File, NIH/CDE Schema</a>
                </li>
            </ul>
        </div>
        <button *ngIf="quickBoardService.canAddElement(elt)" id="addToQuickBoard"
                class="btn   btn-outline-dark"
                title="Add to Compare List" (click)="quickBoardService.addToQuickBoard(elt)">
            <i class="fa fa-plus mr-1"></i><span class="d-none d-sm-inline-block">Add to Quick Board</span>
        </button>
        <button id="addToBoard" class="btn   btn-outline-dark" title="Add to Board"
                (click)="mltPinModal.pinOne(elt, mltPinModal.open())">
            <i class="fa fa-thumb-tack mr-1"></i><span class="d-none d-sm-inline-block">Add to Board</span>
        </button>
        <button *ngIf="isAllowedModel.isOrgCurator()" id="copyCdeBtn" class="btn   btn-outline-dark"
                title="Copy CDE" (click)="openCopyElementModal()">
            <i class="fa fa-clone mr-1"></i><span class="d-none d-sm-inline-block">Copy</span>
        </button>
        <button id="discussBtn" class="btn   btn-outline-dark" title="Discuss CDE"
                (click)="commentMode = !commentMode;">
            <i class="fa fa-comment mr-1" [ngClass]="{'faa-wrench faa-slow animated': hasComments && !commentMode}">
            </i><span class="d-none d-sm-inline-block">Discuss</span>
        </button>
        <div class="navbar-expand-md navbar-light d-inline-block">
            <button class="btn  btn-outline-dark navbar-toggler hidden-md-up"
                    data-toggle="collapse" data-target="#leftNav" aria-controls="leftNav"
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </div>
    <div class="pull-right text-end">
        <ng-container *ngIf="elt.isDraft">
            {{savingText}}
            <button *ngIf="elt.valueDomain.allValid" class="btn  btn-success" id="openSave"
                    (click)="saveModal.openSaveModal();">
                <i class="fa fa-globe fa-lg mr-1"></i>Publish
            </button>
            <button class="btn  btn-danger" id="deleteDraftBtn" (click)="removeDraft();">
                <i class="fa fa-trash fa-lg mr-1"></i>Delete Draft
            </button>
            <br>Changed by {{elt.updatedBy?.username}} on {{elt.updated | date: 'MM/dd/yyyy @ h:mma'}}
        </ng-container>
    </div>
    <div class="py-2 clearfix"></div>
    <div class="row">
        <div [ngClass]="{'col-9 eltCommentView':commentMode,'col-12':!commentMode}">
            <div class="row">
                <div class="col-xl-2 col-lg-3 col-md-4 col-12 navbar-expand-md navbar-light">
                    <div id="leftNav" class="collapse navbar-collapse">
                        <ul class="list-group">
                            <a id="general_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='general_tab'}"
                               (click)="setCurrentTab('general_tab');">General Detail
                                <i *ngIf="tabsCommented.indexOf('general_tab') > -1" class="fa fa-comments pull-right"
                                   aria-hidden="true">&nbsp;</i></a>
                            <a id="pvs_tab" class="list-group-item" [ngClass]="{'active':currentTab ==='pvs_tab'}"
                               (click)="setCurrentTab('pvs_tab');">Permissible Values
                                <i *ngIf="tabsCommented.indexOf('pvs_tab') > -1" class="fa fa-comments pull-right"
                                   aria-hidden="true"></i></a>
                            <a id="naming_tab" class="list-group-item" [ngClass]="{'active':currentTab ==='naming_tab'}"
                               (click)="setCurrentTab('naming_tab');">Naming
                                <i *ngIf="tabsCommented.indexOf('naming_tab') > -1" class="fa fa-comments pull-right"
                                   aria-hidden="true"></i></a>
                            <a id="classification_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='classification_tab'}"
                               (click)="setCurrentTab('classification_tab');">Classification
                                <i *ngIf="tabsCommented.indexOf('classification_tab') > -1"
                                   class="fa fa-comments pull-right"
                                   aria-hidden="true"></i></a>
                            <a id="concepts_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='concepts_tab'}"
                               (click)="setCurrentTab('concepts_tab');">Concepts
                                <i *ngIf="tabsCommented.indexOf('concepts_tab') > -1" class="fa fa-comments pull-right"
                                   aria-hidden="true"></i></a>
                            <a id="referenceDocuments_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='referenceDocuments_tab'}"
                               (click)="setCurrentTab('referenceDocuments_tab');">Reference Documents
                                <i *ngIf="tabsCommented.indexOf('referenceDocuments_tab') > -1"
                                   class="fa fa-comments pull-right"
                                   aria-hidden="true"></i></a>
                            <a id="properties_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='properties_tab'}"
                               (click)="setCurrentTab('properties_tab');">Properties
                                <i *ngIf="tabsCommented.indexOf('properties_tab') > -1"
                                   class="fa fa-comments pull-right"
                                   aria-hidden="true"></i></a>
                            <a id="ids_tab" class="list-group-item" [ngClass]="{'active':currentTab ==='ids_tab'}"
                               (click)="setCurrentTab('ids_tab');">Identifiers
                                <i *ngIf="tabsCommented.indexOf('ids_tab') > -1" class="fa fa-comments pull-right"
                                   aria-hidden="true"></i></a>
                            <a id="attachments_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='attachments_tab'}"
                               (click)="setCurrentTab('attachments_tab');">Attachments
                                <i *ngIf="tabsCommented.indexOf('attachments_tab') > -1"
                                   class="fa fa-comments pull-right"
                                   aria-hidden="true"></i></a>
                            <a id="history_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='history_tab'}"
                               (click)="setCurrentTab('history_tab');">History
                                <i *ngIf="tabsCommented.indexOf('history_tab') > -1" class="fa fa-comments pull-right"
                                   aria-hidden="true"></i></a>
                            <a id="rules_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='rules_tab'}"
                               (click)="setCurrentTab('rules_tab');">Rules
                                <i *ngIf="tabsCommented.indexOf('rules_tab') > -1"
                                   class="fa fa-comments pull-right"
                                   aria-hidden="true"></i></a>
                        </ul>
                    </div>
                </div>
                <div id="middleView" class="col-xl-10 col-lg-9 col-md-8 col-12">
                    <ng-container *ngIf="currentTab === 'general_tab'">
                        <cde-de-general-details [(elt)]="elt" [canEdit]="canEdit()"
                                                (onEltChange)="saveDraft();"></cde-de-general-details>
                        <cde-admin-item-sources [elt]="elt"></cde-admin-item-sources>
                        <cde-registration [elt]="elt" (onEltChange)="saveDraft()"
                                          [canEdit]="canEdit()"></cde-registration>
                        <div role="group" aria-label="More Info">
                            <cde-linked-forms [elt]="elt"></cde-linked-forms>
                            <cde-mlt [elt]="elt"></cde-mlt>
                            <cde-linked-boards [elt]="elt"></cde-linked-boards>
                            <cde-datasets [elt]="elt"></cde-datasets>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'pvs_tab'">
                        <cde-permissible-value [elt]="elt" [canEdit]="canEdit()"
                                               (onEltChange)="saveDraft();"></cde-permissible-value>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'naming_tab'">
                        <cde-naming [elt]="elt" [orgNamingTags]="orgNamingTags" [canEdit]="canEdit()"
                                    (onEltChange)="saveDraft();"></cde-naming>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'classification_tab'">
                        <cde-cde-classification [elt]="elt"></cde-cde-classification>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'concepts_tab'">
                        <cde-concepts [elt]="elt" [canEdit]="canEdit()" (onEltChange)="saveDraft();"></cde-concepts>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'referenceDocuments_tab'">
                        <cde-reference-document [elt]="elt" [canEdit]="canEdit()" (onEltChange)="saveDraft();">
                        </cde-reference-document>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'properties_tab'">
                        <cde-properties [elt]="elt" [canEdit]="canEdit()" (onEltChange)="saveDraft()">
                        </cde-properties>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'ids_tab'">
                        <cde-identifiers [elt]="elt" [canEdit]="canEdit()" (onEltChange)="saveDraft()">
                        </cde-identifiers>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'attachments_tab'">
                        <cde-attachments [elt]="elt" [canEdit]="canEdit()"
                                         (removeAttachment)="removeAttachment($event);"
                                         (setDefault)="setDefault($event)"
                                         (upload)="upload($event);"></cde-attachments>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'history_tab'">
                        <cde-history [elt]="elt" [canEdit]="canEdit()"></cde-history>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'rules_tab'">
                        <cde-derivation-rules [elt]="elt" (onEltChange)="saveDraft();"></cde-derivation-rules>
                        <cde-valid-rules [elt]="elt"></cde-valid-rules>
                    </ng-container>
                </div>
            </div>
        </div>
        <div *ngIf="commentMode" [ngClass]="{'col-3':commentMode,'':!commentMode}"
             style="padding-left:10px;box-shadow: inset 10px 0 5px -2px #888;background-color: #f5f5f5;">
            <cde-discuss-area #commentAreaComponent [selectedElt]="currentTab" [eltId]="elt.tinyId" [elt]="elt"
                              (highlightedTabsChange)="loadHighlightedTabs($event)"
                              [eltName]="elt.naming[0].designation"></cde-discuss-area>
        </div>
    </div>
    <div *ngIf="elt.valueDomain.allValid === false" class="row alert alert-danger mt20"
         role="alert">There are validation errors. {{elt.valueDomain.pvNotValidMsg}}
    </div>
    <cde-save-modal #saveModal [elt]="elt" (save)="saveDataElement()"></cde-save-modal>
</div>

<ng-template #copyDataElementContent id="copyDataElementModal" let-c="close" let-d="dismiss">
    <div class="modal-header" id="copyDataElementModalHeader">
        <h4 class="modal-title">Create a copy</h4>
    </div>
    <div class="modal-body" id="copyDataElementModalBody">
        <p class="text-info">You are about to create a new CDE/Form by duplicating this one. Please specify a new name
            and a classification of the CDE/Form.</p>
        <cde-create-data-element [elt]="eltCopy" (close)="c()" (dismiss)="d()"></cde-create-data-element>
    </div>
</ng-template>

<cde-pin-board-modal #mltPinModal module="cde"></cde-pin-board-modal>
