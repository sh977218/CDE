<div *ngIf="!elt">
    <mat-spinner style="margin: 0 auto"></mat-spinner>
</div>
<div class="container-fluid" itemscope="http://schema.org/MedicalCode">
    <mat-sidenav-container>
        <mat-sidenav #navDrawer mode="side" opened fixedInViewport="true" fixedTopGap="64" fixedBottomGap="134">
            <mat-list id="side-nav" role="list" class="border-1">
                <a mat-list-item role="listitem" *ngFor="let sideNavItem of sideNavItems" class="hand-cursor"
                   [class.bg-active]="activeSection === sideNavItem.fragment" [id]="sideNavItem.id"
                   (click)="gotoSection(sideNavItem.fragment);">
                    {{sideNavItem.label}}
                    <span class="spacer"></span>
                    <mat-icon *ngIf="sideNavItem.hasComment">forum</mat-icon>
                </a>
            </mat-list>
        </mat-sidenav>
        <mat-sidenav #commentDrawer mode="side" position="end" class="mw-20">
            <div class="comment-div" *ngIf="elt">
                <cde-discuss-area [currentTab]="currentTab" [elt]="elt"
                                  (highlightedTabsChange)="loadHighlightedTabs($event)"
                                  [eltName]="elt.designations[0].designation"></cde-discuss-area>
            </div>
        </mat-sidenav>
        <mat-sidenav-content>
            <div id="content-view-div" class="px-2" *ngIf="elt">
                <div id="warning">
                    <div *ngIf="elt.archived" class="alert alert-warning" role="alert">
                        <mat-icon>warning</mat-icon>
                        <strong>Warning:</strong> this data element is archived. You can
                        <a routerLink="/deView" [queryParams]="{tinyId: elt.tinyId}">view the current version here</a>.
                    </div>
                    <div *ngIf="elt.registrationState.registrationStatus==='Retired'" class="alert alert-warning"
                         role="alert">
                        <mat-icon>warning</mat-icon>
                        <strong>Warning:</strong> this data element is retired.
                        <a *ngIf="elt.registrationState.replacedBy" routerLink="/deView"
                           [queryParams]="{tinyId: elt.registrationState.replacedBy.tinyId}">Replacement</a>
                    </div>
                    <div *ngIf="elt.registrationState.administrativeStatus==='Retire Candidate'"
                         class="alert alert-warning"
                         role="alert">
                        <mat-icon>warning</mat-icon>
                        <strong>Warning:</strong> this data element is about to be retired.
                        <a *ngIf="elt.registrationState.replacedBy" routerLink="/deView"
                           [queryParams]="{tinyId: elt.registrationState.replacedBy.tinyId}">Possible Replacement</a>
                    </div>
                    <div *ngIf="displayStatusWarning" class="alert alert-info" role="alert">
                        <mat-icon>warning</mat-icon>
                        <strong>Note:</strong> You may not edit this CDE because it is standard.
                    </div>
                    <div *ngIf="validationErrors.length > 0" class="alert alert-warning" role="alert">
                        <mat-icon>warning</mat-icon>
                        The following errors need to be corrected in order to Publish:
                        <ul class="list-inline">
                            <li *ngFor="let error of validationErrors">{{error.message}}</li>
                        </ul>
                    </div>
                </div>
                <div id="eltName">
                    <h3 class="mobileViewH1 my-4">
                        <cde-draft-slider [(isDraft)]="elt.isDraft" (isDraftChange)="$event?loadElt():loadPublished()"
                                          [hidden]="!hasDrafts"></cde-draft-slider>
                        {{elt?.designations[0]?.designation}}
                    </h3>
                </div>
                <div id="eltMenu">
                    <mat-toolbar class="bg-white">
                        <mat-toolbar-row>
                            <button mat-raised-button id="toggleSidenavBtn" color="primary"
                                    (click)="navDrawer.toggle();">
                                <mat-icon>menu</mat-icon>
                            </button>
                            <button mat-raised-button id="export" class="mr-1" #exportMenuTrigger="matMenuTrigger"
                                    [matMenuTriggerFor]="exportMenu" color="primary">
                                <mat-icon>play_for_work</mat-icon>
                                <span class="d-none d-md-inline-block"> Export </span>
                                <mat-icon>arrow_drop_down</mat-icon>
                            </button>
                            <mat-menu #exportMenu>
                                <a mat-menu-item *ngIf="exportToTab; else exportFileJson" class="no-link"
                                   href="/server/de/byId/{{elt._id}}" target="_blank" rel="noopener noreferrer">
                                    JSON File, NIH/CDE Schema
                                    <ng-container *ngTemplateOutlet="exportJsonActions"></ng-container>
                                </a>
                                <ng-template #exportFileJson>
                                    <a mat-menu-item (click)="exportService.exportDe(elt, '', 'json')">
                                        JSON File, NIH/CDE Schema
                                        <ng-container *ngTemplateOutlet="exportJsonActions"></ng-container>
                                    </a>
                                </ng-template>
                                <ng-template #exportJsonActions>
                                    <a href="/schema/de" target="_blank" rel="noopener noreferrer"
                                       title="Schema" (click)="$event.stopPropagation(); exportMenuTrigger.closeMenu()">
                                        <mat-icon class="menuActionIcon">help_outline</mat-icon>
                                    </a>
                                </ng-template>
                                <a mat-menu-item *ngIf="exportToTab; else exportFileXml" class="no-link"
                                   href="/server/de/byId/{{elt._id}}?type=xml" target="_blank"
                                   rel="noopener noreferrer">
                                    XML File, NIH/CDE Schema
                                </a>
                                <ng-template #exportFileXml>
                                    <a mat-menu-item (click)="exportService.exportDe(elt, '?type=xml', 'xml')">
                                        XML File, NIH/CDE Schema
                                    </a>
                                </ng-template>
                            </mat-menu>
                            <button *ngIf="quickBoardService.canAddElement(elt)" id="addToQuickBoard" mat-raised-button
                                    color="primary"
                                    title="Add to Compare List" (click)="quickBoardService.addToQuickBoard(elt)">
                                <mat-icon>add</mat-icon>
                                <span class="d-none d-md-inline-block"> Add to Quick Board</span>
                            </button>
                            <button id="addToBoard" mat-raised-button color="primary"
                                    (click)="mltPinModal.pinMultiple([elt], mltPinModal.open())">
                                <mat-icon svgIcon="thumb_tack"></mat-icon>
                                <span class="d-none d-md-inline-block">Add to Board</span>
                            </button>
                            <button *ngIf="isOrgCurator(userService.user)" id="copyCdeBtn" mat-raised-button
                                    title="Copy CDE" (click)="openCopyElementModal()" color="primary">
                                <mat-icon>content_copy</mat-icon>
                                <span class="d-none d-md-inline-block"> Copy</span>
                                <span class="d-none d-md-inline-block"> Copy</span>
                            </button>
                            <button id="discussBtn" title="Discuss CDE" mat-raised-button color="primary"
                                    (click)="commentDrawer.toggle();">
                                <mat-icon [ngClass]="{'faa-wrench faa-slow animated': comments.length && !commentMode}">
                                    comment
                                </mat-icon>
                                <span class="d-none d-md-inline-block ml-1"> Discuss</span>
                            </button>
                            <span class="spacer"></span>
                            <ng-container *ngIf="elt.isDraft">
                                <div>{{savingText}}</div>
                                <button mat-raised-button color="warn" id="deleteDraftBtn"
                                        (click)="deleteModal.openDeleteModal()">
                                    <mat-icon>delete</mat-icon>
                                    <span class="d-none d-sm-inline-block"> Delete Draft </span>
                                </button>
                                <button id="openSave" mat-raised-button color="primary" (click)="publish()">
                                    <mat-icon>publish</mat-icon>
                                    <span class="d-none d-sm-inline-block"> Publish</span>
                                </button>
                                <span id="viewChangesBtn" class="fake-link hand-cursor"
                                      (click)="viewChanges();">Changed </span>
                                by {{elt.updatedBy?.username}} on {{elt.updated | date: 'MM/dd/yyyy @ h:mma'}}
                            </ng-container>
                        </mat-toolbar-row>
                    </mat-toolbar>
                </div>
                <div class="row mh-500">
                    <div class="col-12">
                        <div #generalDetails id="general-details-div">
                            <cde-de-general-details [elt]="elt" [canEdit]="canEdit()"
                                                    (eltChange)="saveDraftVoid()"></cde-de-general-details>
                            <cde-admin-item-sources [elt]="elt"></cde-admin-item-sources>
                            <cde-registration [elt]="elt" (eltChange)="saveDraftVoid()"
                                              [canEdit]="canEdit()"></cde-registration>
                            <div role="group" aria-label="More Info">
                                <cde-linked-forms [elt]="elt"></cde-linked-forms>
                                <cde-mlt [elt]="elt"></cde-mlt>
                                <cde-linked-boards [elt]="elt"></cde-linked-boards>
                                <cde-datasets [elt]="elt"></cde-datasets>
                            </div>
                        </div>
                        <div #permissibleValue id="permissible-values-div">
                            <cde-permissible-value [elt]="elt" [canEdit]="canEdit()"
                                                   (eltChange)="saveDraftVoid()"></cde-permissible-value>
                        </div>
                        <div #naming id="naming-div">
                            <cde-naming [elt]="elt" [canEdit]="canEdit()"
                                        (eltChange)="saveDraftVoid()"></cde-naming>
                        </div>
                        <div #classification id="classification-div">
                            <cde-cde-classification [elt]="elt"
                                                    (eltChange)="eltLoaded($event)"></cde-cde-classification>
                        </div>
                        <div #concepts id="concepts-div">
                            <cde-concepts [elt]="elt" [canEdit]="canEdit()"
                                          (eltChange)="saveDraftVoid()"></cde-concepts>
                        </div>
                        <div #referenceDocuments id="reference-documents-div">
                            <cde-reference-document [elt]="elt" [canEdit]="canEdit()"
                                                    (eltChange)="saveDraftVoid()"></cde-reference-document>
                        </div>
                        <div #properties id="properties-div">
                            <cde-properties [elt]="elt" [canEdit]="canEdit()" (eltChange)="saveDraftVoid()">
                            </cde-properties>
                        </div>
                        <div #identifiers id="identifiers-div">
                            <cde-identifiers #identifiers [elt]="elt" [canEdit]="canEdit()"
                                             (eltChange)="saveDraftVoid()">
                            </cde-identifiers>
                        </div>
                        <div #attachments id="attachments-div">
                            <cde-attachments [elt]="elt" [canEdit]="canEdit()"
                                             (removeAttachment)="removeAttachment($event);"
                                             (setDefault)="setDefault($event)"
                                             (upload)="upload($event);"></cde-attachments>
                        </div>
                        <div #history id="history-div">
                            <cde-history [elt]="elt" [canEdit]="canEdit()"></cde-history>
                        </div>
                        <div #rules id="rules-div" class="mb-5 pb-5">
                            <h4 class="section-header">Rules</h4>
                            <div class="mx-4 mb-5">
                                <cde-derivation-rules [canEdit]="canEdit()" [elt]="elt" (eltChange)="saveDraftVoid()">
                                </cde-derivation-rules>
                                <cde-valid-rules [elt]="elt"></cde-valid-rules>
                            </div>
                        </div>
                    </div>
                </div>
                <cde-save-modal #saveModal [elt]="elt" (eltChange)="saveDraftVoid()" (save)="saveDataElement()"></cde-save-modal>
                <cde-delete-modal #deleteModal (confirm)="removeDraft()"></cde-delete-modal>
            </div>
        </mat-sidenav-content>
    </mat-sidenav-container>
</div>

<ng-template #copyDataElementContent>
    <h4 mat-dialog-title>Create a copy</h4>
    <div mat-dialog-content>
        <p class="text-info">You are about to create a new CDE/Form by duplicating this one. Please specify a new name
            and a classification of the CDE/Form.</p>
        <cde-create-data-element [elt]="eltCopy" (close)="modalRef.close()"
                                 (dismiss)="modalRef.close()"></cde-create-data-element>
    </div>
</ng-template>

<cde-pin-board-modal #mltPinModal module="cde"></cde-pin-board-modal>
