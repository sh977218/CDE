<div id="permissibleValueDiv">
    <h4>Values Allowed</h4>
    <div class="col-xs-2 text-right text_label">Value Type:</div>
    <div class="col-xs-10">
        <div class="col-xs-4 noLeftPadding" id="datatypeSelect">
            <select2 [data]="dataTypeOptions" [value]="elt.valueDomain.datatype" [options]="options"
                     width="100%" (valueChanged)="changedDatatype($event)"
                     [disabled]="!isAllowedModel.isAllowed(elt)">
            </select2>
        </div>
    </div>
    <ng-container *ngIf="elt.valueDomain.definition">
        <div class="col-xs-2 text-right text_label">Instructions:</div>
        <div class="col-xs-10" id="instructions">
            {{elt.valueDomain.definition}}
        </div>
    </ng-container>
    <div class="col-xs-2 text-right text_label">Unit of Measure:</div>
    <div class="col-xs-10">
        <cde-inline-edit id="uom" [(model)]="elt.valueDomain.uom" (modelChange)="stageElt()"
                         [isAllowed]="isAllowedModel.isAllowed(elt)"></cde-inline-edit>
    </div>
    <div class="col-xs-2 text-right text_label">Ids:</div>
    <div class="col-xs-10" id="identifiers">
        <ng-container *ngIf="!elt.valueDomain.ids || elt.valueDomain.ids.length===0">
            empty
        </ng-container>
        <div *ngFor="let id of elt.valueDomain.ids">{{id.source}}: {{id.id}}<span
                *ngIf="id.version">, version: </span>{{id.version}}
        </div>
    </div>
    <ng-container *ngIf="elt.valueDomain.datatype.toLowerCase() == 'text'">
        <div class="col-xs-2 text-right text_label">Minimum Length:</div>
        <div class="col-xs-10">
            <cde-inline-edit id="datatypeTextMin" [(model)]="elt.valueDomain.datatypeText.minLength"
                             [inputType]="'Number'" (modelChange)="stageElt()"
                             [isAllowed]="isAllowedModel.isAllowed(elt)"></cde-inline-edit>
        </div>
        <div class="col-xs-2 text-right text_label">Maximum Length:</div>
        <div class="col-xs-10">
            <cde-inline-edit id="datatypeTextMax" [(model)]="elt.valueDomain.datatypeText.maxLength"
                             [inputType]="'Number'" (modelChange)="stageElt()"
                             [isAllowed]="isAllowedModel.isAllowed(elt)"></cde-inline-edit>
        </div>
        <div class="col-xs-2 text-right text_label">Regular Expression:</div>
        <div class="col-xs-10">
            <cde-inline-edit id="datatypeTextRegex" [(model)]="elt.valueDomain.datatypeText.regex"
                             (modelChange)="stageElt()" [isAllowed]="isAllowedModel.isAllowed(elt)"></cde-inline-edit>
        </div>
        <div class="col-xs-2 text-right text_label">Free text rule:</div>
        <div class="col-xs-10">
            <cde-inline-edit id="datatypeTextRule" [(model)]="elt.valueDomain.datatypeText.rule"
                             (modelChange)="stageElt()" [isAllowed]="isAllowedModel.isAllowed(elt)"></cde-inline-edit>
        </div>
    </ng-container>
    <ng-container *ngIf="elt.valueDomain.datatype.toLowerCase() == 'number'">
        <div class="col-xs-2 text-right text_label">Minimum Value:</div>
        <div class="col-xs-10">
            <cde-inline-edit id="datatypeNumberMin" [(model)]="elt.valueDomain.datatypeNumber.minValue"
                             [inputType]="'Number'" (modelChange)="stageElt()"
                             [isAllowed]="isAllowedModel.isAllowed(elt)"></cde-inline-edit>
        </div>
        <div class="col-xs-2 text-right text_label">Maximum Value:</div>
        <div class="col-xs-10">
            <cde-inline-edit id="datatypeNumberMax" [(model)]="elt.valueDomain.datatypeNumber.maxValue"
                             [inputType]="'Number'" (modelChange)="stageElt()"
                             [isAllowed]="isAllowedModel.isAllowed(elt)"></cde-inline-edit>
        </div>
        <div class="col-xs-2 text-right text_label">Precision:</div>
        <div class="col-xs-10">
            <cde-inline-edit id="datatypeNumberPrecision" [(model)]="elt.valueDomain.datatypeNumber.precision"
                             (modelChange)="stageElt()" [isAllowed]="isAllowedModel.isAllowed(elt)"></cde-inline-edit>
        </div>
    </ng-container>
    <ng-container *ngIf="elt.valueDomain.datatype.toLowerCase() === 'date'">
        <div class="col-xs-2 text-right text_label">Date Format:</div>
        <div class="col-xs-10">
            <cde-inline-edit id="datatypeDateFormat" [(model)]="elt.valueDomain.datatypeDate.format"
                             (modelChange)="stageElt()" [isAllowed]="isAllowedModel.isAllowed(elt)"></cde-inline-edit>
        </div>
    </ng-container>
    <ng-container *ngIf="elt.valueDomain.datatype.toLowerCase() === 'file'">
        <div class="col-xs-2 text-right text_label">File</div>
        <div class="col-xs-10"></div>
    </ng-container>
    <ng-container *ngIf="elt.valueDomain.datatype.toLowerCase() === 'externally defined'">
        <div class="col-xs-2 text-right text_label">Link:</div>
        <div class="col-xs-10">
            <cde-inline-edit id="datatypeExternallyDefinedLink"
                             [(model)]="elt.valueDomain.datatypeExternallyDefined.link"
                             (modelChange)="stageElt()" [isAllowed]="isAllowedModel.isAllowed(elt)"></cde-inline-edit>
        </div>
        <div class="col-xs-2 text-right text_label">Description:</div>
        <div class="col-xs-10">
            <inline-area-edit [(model)]="elt.valueDomain.datatypeExternallyDefined.description"
                              [isAllowed]="isAllowedModel.isAllowed(elt)"
                              [(defFormat)]="elt.valueDomain.datatypeExternallyDefined.descriptionFormat"></inline-area-edit>
        </div>
    </ng-container>
    <ng-container *ngIf="elt.valueDomain.datatype.toLowerCase() === 'value list'">
        <h4>Permissible Value</h4>
        <div class="col-xs-2 text-right text_label">Datatype:</div>
        <div class="col-xs-10">
            <cde-inline-edit [(model)]="elt.valueDomain.datatypeValueList.datatype" (ngModelChange)="fixDatatype()"
                             [isAllowed]="isAllowedModel.isAllowed(elt)" [inputType]="'select'" (onOk)="foo($event)"
                             [selectOptions]="dataTypeValueListOptions"></cde-inline-edit>
        </div>
        <div *ngIf="containsKnownSystem">The list below includes codes with synonyms, you can also view them as:<br>
            <span *ngFor="let source of SOURCES | keys" style="margin-left: 50px">
                <input id="display{{SOURCES[source].source}}Codes" title="{{source}}" type="checkbox"
                       [(ngModel)]="SOURCES[source].selected"
                       [disabled]="SOURCES[source].disabled && !isAllowedModel.loggedIn()"
                       (ngModelChange)="lookupAsSource(source)">{{source}} Codes
                <span *ngIf="!isAllowedModel.loggedIn() && SOURCES[source].disabled"> (Login to enable)</span>
            </span>
        </div>
        <ng-container *ngIf="!(elt.valueDomain.permissibleValues.length > 0)">
            <h4>No Permissible Values</h4>
        </ng-container>
        <ng-container *ngIf="elt.valueDomain.permissibleValues.length > 0">
            <table class="table table-bordered table-condensed table-striped">
                <tr>
                    <th>Value</th>
                    <th>Code Name</th>
                    <th>Code</th>
                    <th>Code System</th>
                    <th *ngIf="SOURCES['UMLS'].selected" colspan="2">UMLS</th>
                    <th *ngIf="SOURCES['NCI Thesaurus'].selected" colspan="2">NCI Thesaurus</th>
                    <th *ngIf="SOURCES['LOINC'].selected" colspan="2">LOINC</th>
                    <th *ngIf="SOURCES['SNOMEDCT US'].selected" colspan="2">SNOMEDCT US</th>
                    <th>Code Description</th>
                    <th>Actions</th>
                </tr>
                <tr *ngFor="let pv of elt.valueDomain.permissibleValues; let i=index" id="pv_{{i}}">
                    <td id="pvValue_{{i}}">
                        <cde-inline-edit [(model)]="pv.permissibleValue" [isAllowed]="isAllowedModel.isAllowed(elt)"
                                         (modelChange)="checkPvUnicity();stageElt();"></cde-inline-edit>
                    </td>
                    <td id="pvMeaningName_{{i}}">{{pv.valueMeaningName}}</td>
                    <td id="pvMeaningCode_{{i}}">{{pv.valueMeaningCode}}</td>
                    <td id="pvCodeSystem_{{i}}">{{pv.codeSystemName}}</td>
                    <td *ngIf="SOURCES['UMLS'].selected" id="codeAsUMLS_{{i}}">
                        {{SOURCES['UMLS'].codes[pv.valueMeaningCode].code}}
                    </td>
                    <td *ngIf="SOURCES['UMLS'].selected" id="nameAsUMLS_{{i}}">
                        {{SOURCES['UMLS'].codes[pv.valueMeaningCode].meaning}}
                    </td>
                    <td *ngIf="SOURCES['NCI Thesaurus'].selected" id="codeAsNCI_{{i}}">
                        {{SOURCES['NCI Thesaurus'].codes[pv.valueMeaningCode].code}}
                    </td>
                    <td *ngIf="SOURCES['NCI Thesaurus'].selected" id="nameAsNCI_{{i}}">
                        {{SOURCES['NCI Thesaurus'].codes[pv.valueMeaningCode].meaning}}
                    </td>
                    <td *ngIf="SOURCES['LOINC'].selected" id="codeAsLNC_{{i}}">
                        {{SOURCES['LOINC'].codes[pv.valueMeaningCode].code}}
                    </td>
                    <td *ngIf="SOURCES['LOINC'].selected" id="nameAsLNC_{{i}}">
                        {{SOURCES['LOINC'].codes[pv.valueMeaningCode].meaning}}
                    </td>
                    <td *ngIf="SOURCES['SNOMEDCT US'].selected" id="codeAsSCT_{{i}}">
                        {{SOURCES['SNOMEDCT US'].codes[pv.valueMeaningCode].code}}
                    </td>
                    <td *ngIf="SOURCES['SNOMEDCT US'].selected" id="nameAsSCT_{{i}}">
                        {{SOURCES['SNOMEDCT US'].codes[pv.valueMeaningCode].meaning}}
                    </td>
                    <td id="pvMeaningDefinition_{{i}}">
                        <cde-inline-edit [model]="pv.valueMeaningDefinition"
                                         [isAllowed]="isAllowedModel.isAllowed(elt)"
                                         (modelChange)="stageElt()"></cde-inline-edit>
                    </td>
                    <td>
                        <ng-container *ngIf="pv.notValid">
                            <span class="btn-default fa fa-warning text-danger" id="pv-{{i}}-notValid"></span>
                        </ng-container>
                        <ng-container *ngIf="isAllowedModel.isAllowed(elt)">
                            <span id="pvRemove_{{i}}" class="btn-default fa fa-trash-o" (click)="removePv(i)"
                                  title="Remove" href=""></span>
                            <sortable-array [theArray]="elt.valueDomain.permissibleValues" [index]="i"
                                            (cb)="sortPermissibleValue();"></sortable-array>
                        </ng-container>
                    </td>
                </tr>
            </table>
        </ng-container>
        <div>
            <div *ngIf="!elt.allValid && elt.valueDomain.permissibleValues.length > 0" class="alert alert-danger mt20"
                 role="alert">There are validation errors. {{elt.pvNotValidMsg }}
            </div>
            <ng-container *ngIf="isAllowedModel.isAllowed(elt)">
                <button class="btn btn-small btn-default" role="button" id="openAddPermissibleValueModelBtn"
                        title="Add Permissible Value"
                        (click)="openNewPermissibleValueModal()">
                    <i class="fa fa-plus"></i>Add Permissible Value
                </button>
                <button class="btn btn-small btn-default" role="button" id="removeAllPermissibleValueBtn"
                        title="Remove All Values"
                        (click)="removeAllPermissibleValues()">
                    <i class="fa fa-trash-o"></i>Remove All Values
                </button>
            </ng-container>
        </div>

        <h4>VSAC Value Set</h4>
        <a href="https://vsac.nlm.nih.gov" target="_blank">Lookup Value Sets here.</a>

        <div *ngIf="vsacMappingExists()">
            <dl class="dl-horizontal">
                <dt>Value Set Name:</dt>
                <dd>{{elt.dataElementConcept.conceptualDomain.vsac.name}}</dd>
                <dt>Value Set ID:</dt>
                <dd>{{elt.dataElementConcept.conceptualDomain.vsac.id}}</dd>
                <dt>Value Set Version:</dt>
                <dd>{{elt.dataElementConcept.conceptualDomain.vsac.version}}</dd>
            </dl>
        </div>

        <div *ngIf="!vsacMappingExists()">No Value Set specified.</div>
        <div *ngIf="isAllowedModel.loggedIn()">
            <div>{{vsacError}}</div>
            <div *ngIf="!editMode">
                <a *ngIf="isAllowedModel.isAllowed(elt)" class="btn btn-default"
                   id="updateOIDBtn" (click)="editMode=true">Update O.I.D</a>
                <a *ngIf="isAllowedModel.isAllowed(elt) && vsacMappingExists()" class="btn btn-default"
                   id="removeVSButton" (click)="removeVSMapping()">Remove Mapping</a>
            </div>
            <div *ngIf="editMode">
                <input name="vsacId" type="text" [(ngModel)]="elt.dataElementConcept.conceptualDomain.vsac.id"
                       placeholder="VSAC O.I.D"/>
                <i id="vsacIdCheck" class="fa fa-check" (click)="checkVsacId(elt)"></i>
                <i class="fa fa-times" (click)="editMode = false"></i>
            </div>
        </div>
        <hr/>
        <div *ngIf="!isAllowedModel.loggedIn() && vsacMappingExists()">Please log in to see VSAC mapping.</div>

        <table class="table-bordered table-condensed table-striped" *ngIf="vsacValueSet.length > 0">
            <tr>
                <th>Code Name</th>
                <th>Code</th>
                <th>Code System</th>
                <th id="validation">Match</th>
                <th *ngIf="isAllowedModel.isAllowed(elt)">Actions</th>
            </tr>
            <tr *ngFor="let con of vsacValueSet; let i = index;">
                <td>{{con.displayName}}</td>
                <td>{{con.code}}</td>
                <td>{{con.codeSystemName}}</td>
                <td>
                    <i *ngIf="con.isValid" class="fa fa-check text-success" id="vset-{{i}}-valid"></i>
                    <i *ngIf="!con.isValid" class="fa fa-exclamation text-warning" id="vset-{{i}}-warning"></i>
                </td>
                <td>
                    <i *ngIf="!isVsInPv(con)" class="fa fa fa-plus" id="addVsacValue_{{i}}"
                       (click)="addVsacValue(con)"></i>
                </td>
            </tr>
        </table>
        <div *ngIf="vsacMappingExists() && !isAllowedModel.loggedIn()">Please log in to see VSAC mapping.</div>
        <a *ngIf="vsacMappingExists() && isAllowedModel.isAllowed(elt) && !allVsacMatch()"
           class="btn btn-small btn-default mt20"
           (click)="addAllVsac()"><i id="addAllVsac" class="fa fa-plus"></i> Import Missing Values</a>

    </ng-container>
</div>

<ng-template #newPermissibleValueContent id="newPermissibleValueModal" let-c="close" let-d="dismiss">
    <div class="modal-header" id="newPermissibleValueModalHeader">
        <h4 class="modal-title">Add Naming</h4>
    </div>
    <form role="form" #newPermissibleValueForm="ngForm">
        <div class="modal-body" id="newPermissibleValueModalBody">
            <div class="form-group">
                <label for="permissibleValueInput">Value</label>
                <input class="form-control" [(ngModel)]="newPermissibleValue.permissibleValue"
                       id="permissibleValueInput"
                       name="permissibleValueInput" Placeholder="Permissible Value" required/>
            </div>
            <div class="form-group">
                <label for="valueMeaningNameInput">Code Name</label>
                <input class="form-control" [(ngModel)]="newPermissibleValue.valueMeaningName"
                       id="valueMeaningNameInput" name="valueMeaningNameInput" (ngModelChange)="lookupUmls()"
                       Placeholder="Code Name" (ngModelChange)="lookupUmls()"/>
            </div>
            <div class="form-group">
                <label for="valueMeaningCodeInput">Code</label>
                <input class="form-control" [(ngModel)]="newPermissibleValue.valueMeaningCode"
                       id="valueMeaningCodeInput"
                       name="valueMeaningCodeInput" Placeholder="Code"/>
            </div>
            <div class="form-group">
                <label for="valueMeaningDescInput">Description</label>
                <input class="form-control" [(ngModel)]="newPermissibleValue.valueMeaningDefinition"
                       id="valueMeaningDescInput"
                       name="valueMeaningDescInput" Placeholder="Description"/>
            </div>
            <div class="form-group" *ngIf="newPermissibleValue.valueMeaningCode?.length > 0">
                <label for="codeSystemInput">Code System</label>
                <input class="form-control" [(ngModel)]="newPermissibleValue.codeSystemName" id="codeSystemInput"
                       name="codeSystemInput" Placeholder="Code System" required/>
            </div>
            <div *ngIf="umlsTerms.length > 0">
                <h4>Choices from UMLS: </h4>
                <div *ngFor="let term of umlsTerms; let i = index;">
                    <a *ngIf="i<10" (click)="selectFromUmls(term)" href="#">{{term.ui}} : {{term.name}}</a>
                </div>
            </div>
        </div>
        <div class="modal-footer" id="newPermissibleValueModalFooter">
            <button class="btn cancel" (click)="c('Close click')" id="cancelNewPermissibleValueBtn"
                    name="cancelNewPermissibleValueBtn"
                    type="button">Cancel
            </button>
            <button class="btn btn-warning" [disabled]="!newPermissibleValueForm.form.valid"
                    id="createNewPermissibleValueBtn" name="createNewPermissibleValueBtn" type="submit"
                    (click)="addNewPermissibleValue();">Save
            </button>
        </div>
    </form>
</ng-template>