<div *ngIf="!elt">
    <mat-spinner style="margin: 0 auto"></mat-spinner>
</div>

<button mat-mini-fab style="position: fixed; right: 5px; top: 5px; z-index: 2" (click)="gotoTop()">
    <mat-icon>keyboard_arrow_up</mat-icon>
</button>
<button *ngIf="!navDrawer.opened" class="noPrint slide-pane-button-right" (click)="navDrawer.open()"></button>

<mat-sidenav-container>
    <mat-sidenav #navDrawer class="noPrint" position="end" style="border: 0"
                 [mode]="isMobile ? 'over' : 'side'" [opened]="!isMobile" [disableClose]="!isMobile"
                 fixedInViewport="true" [fixedTopGap]="isMobile ? 0 : 64" [fixedBottomGap]="isMobile ? 0 : 71">
        <div *ngIf="isMobile; else aioToc" (click)="navDrawer.close()">
            <aio-toc></aio-toc>
        </div>
        <ng-template #aioToc>
            <aio-toc></aio-toc>
        </ng-template>
        <div style="min-width: 155px"></div>
    </mat-sidenav>
    <mat-sidenav-content>
        <mat-sidenav-container [hasBackdrop]="false">
            <mat-sidenav #commentDrawer mode="side" position="end" style="max-width: 25%">
                <div *ngIf="elt">
                    <cde-discuss-area #commentAreaComponent [currentTab]="currentTab" [elt]="elt"
                                      (highlightedTabsChange)="loadHighlightedTabs($event)"
                                      [eltName]="elt.designations[0].designation"></cde-discuss-area>
                </div>
            </mat-sidenav>
            <mat-sidenav-content>
                <main *ngIf="elt" class="container-fluid" itemscope="http://schema.org/MedicalCode">
                    <header>
                        <div *ngIf="elt.archived" class="alert alert-warning mt20" role="alert">
                            <mat-icon>warning</mat-icon>
                            <strong>Warning:</strong> this form is archived. You can
                            <a id="viewCurrentEltLink" routerLink="/formView" [queryParams]="{tinyId: elt.tinyId}">view
                                the
                                current
                                version here</a>.
                        </div>
                        <div *ngIf="elt.registrationState.registrationStatus=='Retired'" class="alert alert-warning mt20" role="alert">
                            <mat-icon>warning</mat-icon>
                            <strong>Warning:</strong> this form is retired.
                            <a *ngIf="elt.registrationState.replacedBy"
                               routerLink="/deView" [queryParams]="{tinyId: elt.registrationState.replacedBy.tinyId}">Replacement</a>
                        </div>
                        <div *ngIf="elt.registrationState.administrativeStatus=='Retire Candidate'"
                             class="alert alert-warning mt20"
                             role="alert">
                            <mat-icon>warning</mat-icon>
                            <strong>Warning:</strong> this form is about to be retired.
                            <a *ngIf="elt.registrationState.replacedBy?.tinyId"
                               routerLink="/deView" [queryParams]="{tinyId: elt.registrationState.replacedBy.tinyId}">Possible
                                Replacement</a>
                        </div>
                        <div *ngIf="elt.outdated" class="alert alert-info mt20" role="alert">
                            <mat-icon>warning</mat-icon>
                            <strong>Note: </strong>Some referenced items in this form have newer versions.
                        </div>
                        <div *ngIf="validationErrors.length > 0" class="alert alert-warning mt20" role="alert">
                            <mat-icon>warning</mat-icon>
                            The following errors need to be corrected in order to Publish:
                            <ul class="list-inline">
                                <li *ngFor="let error of validationErrors">
                                    <ng-container *ngIf="!error.id">{{error.message}}</ng-container>
                                    <a class="fake-link" *ngIf="error.id"
                                       (click)="scrollToDescriptionId(error.id)">{{error.message}}</a>
                                </li>
                            </ul>
                        </div>
                    </header>
                    <div class="h1Like">
                        <cde-draft-slider class="mr-2" [(isDraft)]="elt.isDraft" (isDraftChange)="$event?loadElt():loadPublished()"
                                          [hidden]="!hasDraftsAndLoggedIn()">
                        </cde-draft-slider>
                        <h1 class="d-inline">Form: {{elt?.designations[0]?.designation}}</h1>
                    </div>
                    <nav>
                        <button mat-raised-button id="export" title="Export" #exportMenuTrigger="matMenuTrigger"
                                color="primary" [matMenuTriggerFor]="exportMenu">
                            <mat-icon>play_for_work</mat-icon>
                            <span class="d-none d-md-inline ml-1"> Export </span>
                            <mat-icon>arrow_drop_down</mat-icon>
                        </button>
                        <mat-menu #exportMenu>
                            <ng-container *ngIf="userService.loggedIn()">
                                <a mat-menu-item *ngIf="exportToTab; else exportFileJson" class="no-link"
                                   href="/server/form/byId/{{elt._id}}" target="_blank"
                                   rel="noopener noreferrer">
                                    JSON File, NIH/CDE Schema
                                    <ng-container *ngTemplateOutlet="exportJsonActions"></ng-container>
                                </a>
                                <ng-template #exportFileJson>
                                    <a mat-menu-item (click)="exportService.exportForm(elt, '', 'json')">
                                        JSON File, NIH/CDE Schema
                                        <ng-container *ngTemplateOutlet="exportJsonActions"></ng-container>
                                    </a>
                                </ng-template>
                                <ng-template #exportJsonActions>
                                    <a href="/schema/form" target="_blank" rel="noopener noreferrer"
                                       title="Schema"
                                       (click)="$event.stopPropagation(); exportMenuTrigger.closeMenu()">
                                        <mat-icon class="menuActionIcon">help_outline</mat-icon>
                                    </a>
                                </ng-template>
                                <a mat-menu-item *ngIf="exportToTab; else exportFileJson" class="no-link"
                                   href="/server/form/byId/{{elt._id}}?type=xml&subtype=odm" target="_blank"
                                   rel="noopener noreferrer">
                                    XML File, CDISC / ODM
                                    <ng-container *ngTemplateOutlet="exportOdmActions"></ng-container>
                                </a>
                                <ng-template #exportFileOdm>
                                    <a mat-menu-item
                                       (click)="exportService.exportForm(elt, '?type=xml&subtype=odm', 'xml')">
                                        XML File, CDISC / ODM
                                        <ng-container *ngTemplateOutlet="exportOdmActions"></ng-container>
                                    </a>
                                </ng-template>
                                <ng-template #exportOdmActions>
                                    <a href="https://www.cdisc.org/standards/transport/odm" target="_blank"
                                       rel="noopener noreferrer"
                                       title="Information"
                                       (click)="$event.stopPropagation(); exportMenuTrigger.closeMenu()">
                                        <mat-icon class="menuActionIcon">help_outline</mat-icon>
                                    </a>
                                </ng-template>
                                <a mat-menu-item *ngIf="exportToTab; else exportFileSdc" class="no-link"
                                   href="/server/form/byId/{{elt._id}}?type=xml&subtype=sdc" target="_blank"
                                   rel="noopener noreferrer">
                                    XML File, SDC Schema
                                    <ng-container *ngTemplateOutlet="exportSdcActions"></ng-container>
                                </a>
                                <ng-template #exportFileSdc>
                                    <a mat-menu-item
                                       (click)="exportService.exportForm(elt, '?type=xml&subtype=sdc', 'xml')">
                                        XML File, SDC Schema
                                        <ng-container *ngTemplateOutlet="exportSdcActions"></ng-container>
                                    </a>
                                </ng-template>
                                <ng-template #exportSdcActions>
                                    <a href="https://github.com/esacinc/sdc-schema-package" target="_blank"
                                       rel="noopener noreferrer"
                                       title="Information"
                                       (click)="$event.stopPropagation(); exportMenuTrigger.closeMenu()">
                                        <mat-icon class="menuActionIcon">help_outline</mat-icon>
                                    </a>
                                    <a href="/server/form/byId/{{elt._id}}?type=xml&subtype=sdc&validate=true"
                                       target="_blank" rel="noopener noreferrer"
                                       title="Validate"
                                       (click)="$event.stopPropagation(); exportMenuTrigger.closeMenu()">
                                        <mat-icon class="menuActionIcon" style="color: green">check</mat-icon>
                                    </a>
                                </ng-template>
                                <a mat-menu-item *ngIf="!isIe()" class="no-link"
                                   href="/server/form/byId/{{elt._id}}?type=xml&subtype=sdc&renderer=defaultHtml"
                                   target="_blank" rel="noopener noreferrer">
                                    XML File, SDC Schema with XSL Transform
                                </a>
                                <a mat-menu-item *ngIf="exportToTab; else exportFileXml" class="no-link"
                                   href="/server/form/byId/{{elt._id}}?type=xml" target="_blank"
                                   rel="noopener noreferrer">
                                    XML File, NIH/CDE Schema
                                </a>
                                <ng-template #exportFileXml>
                                    <a mat-menu-item
                                       (click)="exportService.exportForm(elt, '?type=xml', 'xml')">
                                        XML File, NIH/CDE Schema
                                    </a>
                                </ng-template>
                                <a mat-menu-item (click)="openExportPublishModal()">
                                    Published Form
                                </a>
                                <a mat-menu-item (click)="exportService.redcapExport(elt)">
                                    REDCap
                                    <a href="https://projectredcap.org/" target="_blank"
                                       rel="noopener noreferrer"
                                       title="Information"
                                       (click)="$event.stopPropagation(); exportMenuTrigger.closeMenu()">
                                        <mat-icon class="menuActionIcon">help_outline</mat-icon>
                                    </a>
                                </a>
                                <a mat-menu-item (click)="exportService.formCdeExport(elt)">
                                    CDE Dictionary (CSV)
                                </a>
                                <a mat-menu-item *ngIf="exportToTab; else exportFileQuestionnaire"
                                   class="no-link"
                                   href="/server/form/byId/{{elt._id}}?subtype=fhirQuestionnaire"
                                   target="_blank"
                                   rel="noopener noreferrer">
                                    FHIR Questionnaire
                                    <ng-container *ngTemplateOutlet="exportFhirActions"></ng-container>
                                </a>
                                <ng-template #exportFileQuestionnaire>
                                    <a mat-menu-item
                                       (click)="exportService.exportForm(elt, '?subtype=fhirQuestionnaire', 'json')">
                                        FHIR Questionnaire
                                        <ng-container *ngTemplateOutlet="exportFhirActions"></ng-container>
                                    </a>
                                </ng-template>
                                <ng-template #exportFhirActions>
                                    <a href="https://www.hl7.org/fhir/questionnaire.html" target="_blank"
                                       rel="noopener noreferrer"
                                       title="Schema"
                                       (click)="$event.stopPropagation(); exportMenuTrigger.closeMenu()">
                                        <mat-icon class="menuActionIcon">help_outline</mat-icon>
                                    </a>
                                    <a href="/server/form/byId/{{elt._id}}?subtype=fhirQuestionnaire&validate"
                                       target="_blank" rel="noopener noreferrer"
                                       title="Validate"
                                       (click)="$event.stopPropagation(); exportMenuTrigger.closeMenu()">
                                        <mat-icon class="menuActionIcon" style="color: green">check</mat-icon>
                                    </a>
                                </ng-template>
                            </ng-container>
                            <a class="dropdown-item" *ngIf="!userService.loggedIn()" href="login" mat-menu-item>
                                Please login to export forms.
                            </a>
                        </mat-menu>
                        <button *ngIf="quickBoardService.canAddElement(elt)" id="addToQuickBoard"
                                color="primary"
                                mat-raised-button (click)="quickBoardService.addToQuickBoard(elt)">
                            <mat-icon>add</mat-icon>
                            <span class="d-none d-md-inline ml-1">Add to Quick Board</span>
                        </button>
                        <button id="addToBoard" mat-raised-button color="primary"
                                (click)="mltPinModal.pinMultiple([elt], mltPinModal.open())">
                            <mat-icon svgIcon="thumb_tack"></mat-icon>
                            <span class="d-none d-md-inline-block">Add to Board</span>
                        </button>
                        <button *ngIf="userService.loggedIn()" mat-raised-button color="primary"
                                id="pinAllCdes" (click)="pinAllCdesIntoBoard()">
                            <mat-icon>add_shopping_cart</mat-icon>
                            <span class="d-none d-md-inline ml-1">Pin CDEs</span>
                        </button>
                        <button *ngIf="isOrgCurator(userService.user)" id="copyFormBtn" mat-raised-button
                                color="primary"
                                (click)="openCopyElementModal()">
                            <mat-icon>content_copy</mat-icon>
                            <span class="d-none d-md-inline ml-1">Copy</span>
                        </button>
                        <button id="cdeListBtn" mat-raised-button color="primary" (click)="openFormCdesModal()">
                            <mat-icon>list</mat-icon>
                            <span class="d-none d-md-inline ml-1">CDEs</span>
                        </button>
                        <button id="discussBtn" mat-raised-button color="primary"
                                (click)="commentDrawer.toggle();">
                            <mat-icon [ngClass]="{'faa-wrench faa-slow animated': hasComments && !commentMode}">
                                comment
                            </mat-icon>
                            <span class="d-none d-md-inline ml-1">Discuss</span>
                        </button>
                        <span class="spacer"></span>
                        <ng-container *ngIf="elt.isDraft">
                            {{savingText}}
                            <button id="deleteDraftBtn" title="Delete Draft" mat-raised-button color="warn"
                                    (click)="deleteModal.openDeleteModal()">
                                <mat-icon>delete</mat-icon>
                                <span class="d-none d-sm-inline-block ml-1">Delete Draft</span>
                            </button>
                            <button id="openSave" mat-raised-button color="primary" (click)="publish()"
                                    [disabled]="savingText === 'Saving...'">
                                <mat-icon>publish</mat-icon>
                                <span class="d-none d-sm-inline-block ml-1">Publish</span>
                            </button>
                            <span id="viewChangesBtn" class="fake-link hand-cursor" (click)="viewChanges();"
                                  matTooltip="by {{elt.updatedBy?.username}} on {{elt.updated | date: 'MM/dd/yyyy @ h:mma'}}">
                                    Changed</span>
                        </ng-container>
                    </nav>
                    <article>
                        <div id="preview-div">
                            <cde-native-render-full [elt]="elt" [canEdit]="canEdit()"></cde-native-render-full>
                        </div>
                        <div id="general-details-div">
                            <cde-form-general-details [elt]="elt" [canEdit]="canEdit()"
                                                      (eltChange)="saveDraftVoid()">
                            </cde-form-general-details>
                            <cde-admin-item-sources [elt]="elt"></cde-admin-item-sources>
                            <cde-registration [elt]="elt" (eltChange)="saveDraftVoid()"
                                              [canEdit]="canEdit()"></cde-registration>
                            <cde-linked-boards [elt]="elt"></cde-linked-boards>
                            <cde-linked-forms [elt]="elt"></cde-linked-forms>
                            <cde-form-term-mapping [elt]="elt"></cde-form-term-mapping>
                        </div>
                        <div id="naming-div">
                            <cde-naming [elt]="elt" [canEdit]="canEdit()"
                                        (eltChange)="saveDraftVoid()"></cde-naming>
                        </div>
                        <div id="classification-div">
                            <cde-form-classification [elt]="elt"
                                                     (eltChange)="eltLoaded($event)"></cde-form-classification>
                        </div>
                        <div id="display-profile-div">
                            <cde-display-profile [elt]="elt" [canEdit]="canEdit()" (eltChange)="saveDraftVoid()">
                            </cde-display-profile>
                        </div>
                        <div id="reference-documents-div">
                            <cde-reference-document [elt]="elt" [canEdit]="canEdit()" (eltChange)="saveDraftVoid()">
                            </cde-reference-document>
                        </div>
                        <div id="properties-div">
                            <cde-properties [elt]="elt" [canEdit]="canEdit()" (eltChange)="saveDraftVoid()">
                            </cde-properties>
                        </div>
                        <div id="identifiers-div">
                            <cde-identifiers [elt]="elt" [canEdit]="canEdit()" (eltChange)="saveDraftVoid()">
                            </cde-identifiers>
                        </div>
                        <div id="attachments-div">
                            <cde-attachments [elt]="elt" [canEdit]="canEdit()"
                                             (removeAttachment)="removeAttachment($event);"
                                             (setDefault)="setDefault($event);"
                                             (upload)="upload($event);"></cde-attachments>
                        </div>
                        <div id="history-div" class="mb-3">
                            <cde-history [elt]="elt" [canEdit]="canEdit()"></cde-history>
                        </div>
                    </article>
                    <cde-save-modal #saveModal [elt]="elt" (save)="saveForm()"
                                    (eltChange)="saveDraftVoid()"></cde-save-modal>
                    <cde-delete-modal #deleteModal (confirm)="removeDraft()"></cde-delete-modal>
                </main>
            </mat-sidenav-content>
        </mat-sidenav-container>
    </mat-sidenav-content>
</mat-sidenav-container>

<ng-template #copyFormContent id="copyFormModal">
    <h4 mat-dialog-title>Create a copy</h4>
    <div mat-dialog-content>
        <p class="text-info">You are about to create a new CDE/Form by duplicating this one. Please specify a new name
            and a classification of the CDE/Form.</p>
        <cde-create-form [elt]="eltCopy" (done)="dialogRef.close()"></cde-create-form>
    </div>
</ng-template>
<ng-template #formCdesContent id="formCdesModal">
    <h4 mat-dialog-title>Form CDEs</h4>
    <div mat-dialog-content>
        <question-according-list [formElements]="questions"></question-according-list>
    </div>
</ng-template>
<ng-template #exportPublishModal id="publishFormModal">
    <h3 mat-dialog-title="">Export to a Published Form</h3>
    <form #createPublishedForm="ngForm">
        <div mat-dialog-content>
            <p class="text-info">This export will generate a published version of this form that will submit data to
                the endpoint of your choice. Note that the NIH CDE Repository will not have access to any of the
                submitted.
                You will need to ensure that your endpoint meets your own security standards. A sample endpoint could be
                a Google Spreadsheet (via a Google Script published as a web app).
            </p>
            To get started, please follow these steps:
            <div class="form-group">
                <label for="publishedFormUrl">Copy paste that URL here:</label>
                <input type="url" class="form-control" id="publishedFormUrl" [(ngModel)]="formInput.endpointUrl"
                       name="publishedFormUrl" #endpointUrl="ngModel" required>
                <p *ngIf="endpointUrl.errors">Not a valid URL.</p>
                <p>Your published forms will appear in your profile.</p>
            </div>
            <div class="form-group">
                <label for="publishedFormName">Give your published form a name so you can find it more easily.</label>
                <input class="form-control" id="publishedFormName" [(ngModel)]="formInput.publishedFormName"
                       name="publishedFormName" required>
                Click "Publish my form" below and write down the final URL. This is the url you will open to start
                recording your data.
            </div>
        </div>
        <div mat-dialog-actions>
            <button mat-raised-button color="accent" [mat-dialog-close] id="cancelExport">Cancel</button>
            <button mat-raised-button color="primary" (click)="exportPublishForm()" id="goExport"
                    [disabled]="!createPublishedForm.form.valid">Publish my form.
            </button>
        </div>
    </form>
</ng-template>
<cde-pin-board-modal #mltPinModal module="form"></cde-pin-board-modal>
<cde-pin-board-modal #mltPinModalCde module="cde"></cde-pin-board-modal>
