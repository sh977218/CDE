<div *ngIf="!elt">
    <mat-spinner style="margin: 0 auto"></mat-spinner>
</div>
<div *ngIf="elt?.tinyId" class="container-fluid" itemscope="http://schema.org/MedicalCode">
    <div id="warning">
        <div *ngIf="elt.archived" class="alert alert-warning mt20" role="alert">
            <mat-icon>warning</mat-icon><strong>Warning:</strong> this form is archived. You can
            <a id="viewCurrentEltLink" routerLink="/formView" [queryParams]="{tinyId: elt.tinyId}">view the current
                version here</a>.
        </div>
        <div *ngIf="elt.registrationState.registrationStatus=='Retired'" class="alert alert-warning mt20" role="alert">
            <mat-icon>warning</mat-icon><strong>Warning:</strong> this form is retired.
            <a *ngIf="elt.registrationState.replacedBy"
               routerLink="/deView" [queryParams]="{tinyId: elt.registrationState.replacedBy.tinyId}">Replacement</a>
        </div>
        <div *ngIf="elt.registrationState.administrativeStatus=='Retire Candidate'" class="alert alert-warning mt20"
             role="alert">
            <mat-icon>warning</mat-icon><strong>Warning:</strong> this form is about to be retired.
            <a *ngIf="elt.registrationState.replacedBy?.tinyId"
               routerLink="/deView" [queryParams]="{tinyId: elt.registrationState.replacedBy.tinyId}">Possible
                Replacement</a>
        </div>
        <div *ngIf="elt.outdated" class="alert alert-info mt20" role="alert">
            <mat-icon>warning</mat-icon><strong>Note: </strong>Some referenced items in this form have newer versions.
        </div>
        <div *ngIf="missingCdes.length > 0" class="alert alert-warning mt20" role="alert">
            <mat-icon>warning</mat-icon>
            The following CDEs are part of a score but are missing from this form:
            <ul class="list-inline">
                <li *ngFor="let missCde of missingCdes;let i = index;">
                    <a href="/deView?tinyId={{missCde}}" target="_blank">CDE {{i+1}},id: {{missCde}}</a>
                    <span *ngIf="i < missingCdes.length">,</span></li>
            </ul>
        </div>
        <div *ngIf="validationErrors.length > 0" class="alert alert-warning mt20" role="alert">
            <mat-icon>warning</mat-icon>
            The following errors need to be corrected in order to Publish:
            <ul class="list-inline">
                <li *ngFor="let error of validationErrors">
                    <ng-container *ngIf="!error.id">{{error.message}}</ng-container>
                    <a class="fake-link" *ngIf="error.id" (click)="scrollToDescriptionId(error.id)">{{error.message}}</a>
                </li>
            </ul>
        </div>
    </div>
    <h1 class="mobileViewH1 my-4">
        <cde-draft-slider [(isDraft)]="elt.isDraft" (isDraftChange)="$event?loadElt():loadPublished()"
                          [hidden]="!hasDrafts">
        </cde-draft-slider>
        {{elt?.designations[0]?.designation}}
    </h1>
    <div class="pull-left mb-1">
        <button id="export" mat-raised-button title="Export" [matMenuTriggerFor]="exportMenu">
            <mat-icon>play_for_work</mat-icon>
            <span class="d-none d-md-inline ml-1"> Export </span>
            <mat-icon>arrow_drop_down</mat-icon>
        </button>
        <mat-menu #exportMenu>
            <ng-container *ngIf="userService.loggedIn()">
                <span mat-menu-item>
                    <a id='nihJson' href="formById/{{elt._id}}" target="_blank">
                        JSON File, NIH/CDE Schema</a>
                    <a href="/schema/form" target="_blank" title="Schema">
                        <mat-icon class="menuActionIcon">help_outline</mat-icon></a>
                </span>
                <span mat-menu-item>
                    <a id='odmExport' href="formById/{{elt._id}}?type=xml&subtype=odm" target="_blank">
                        XML File, CDISC / ODM</a>
                    <a href="https://www.cdisc.org/standards/transport/odm" target="_blank" title="Information">
                        <mat-icon class="menuActionIcon">help_outline</mat-icon></a>
                </span>
                <span mat-menu-item>
                    <a id='sdcExport' href="formById/{{elt._id}}?type=xml&subtype=sdc" target="_blank">
                        XML File, SDC Schema</a>
                    <a href="https://github.com/esacinc/sdc-schema-package" target="_blank" title="Information">
                        <mat-icon class="menuActionIcon">help_outline</mat-icon></a>
                    <a href="formById/{{elt._id}}?type=xml&subtype=sdc&validate=true" target="_blank" title="Validate">
                        <mat-icon class="menuActionIcon" style="color: green">check</mat-icon></a>
                </span>
                <a *ngIf="!isIe()" id='sdcHtmlExport' mat-menu-item
                   href="formById/{{elt._id}}?type=xml&subtype=sdc&renderer=defaultHtml"
                   target="_blank">XML File, SDC Schema with XSL Transform</a>
                <a id='nihXml' href="formById/{{elt._id}}?type=xml" target="_blank" mat-menu-item>
                    XML File, NIH/CDE Schema</a>
                <a id='formPublishExport' (click)="openExportPublishModal()" mat-menu-item
                   target="_blank">Published Form</a>
                <span mat-menu-item>
                    <a id='nihRedCap' href="formById/{{elt._id}}?type=REDCap" target="_blank">REDCap</a>
                    <a href="https://projectredcap.org/" target="_blank" title="Information">
                        <mat-icon class="menuActionIcon">help_outline</mat-icon></a>
                </span>
                <span id='formCdesExport' (click)="exportService.formCdeExport(elt)"
                      mat-menu-item>CDE Dictionary (CSV)</span>
                <span mat-menu-item>
                    <a id="asQuestionnaire" href="formById/{{elt._id}}?subtype=fhirQuestionnaire"
                       target="_blank">FHIR Questionnaire</a>
                    <a href="https://www.hl7.org/fhir/questionnaire.html" target="_blank" title="Schema">
                        <mat-icon class="menuActionIcon">help_outline</mat-icon></a>
                    <a href="formById/{{elt._id}}?subtype=fhirQuestionnaire&validate" target="_blank" title="Validate">
                        <mat-icon class="menuActionIcon" style="color: green">check</mat-icon></a>
                </span>
            </ng-container>
            <a class="dropdown-item" *ngIf="!userService.loggedIn()" href="login" mat-menu-item>
                Please login to export forms.</a>
        </mat-menu>
        <button *ngIf="quickBoardService.canAddElement(elt)" id="addToQuickBoard"
                mat-raised-button (click)="quickBoardService.addToQuickBoard(elt)">
            <mat-icon>add</mat-icon>
            <span class="d-none d-md-inline ml-1">Add to Quick Board</span>
        </button>
        <button id="addToBoard" mat-raised-button (click)="mltPinModal.open([elt], 'cde')">
            <mat-icon svgIcon="thumb_tack"></mat-icon><span class="d-none d-md-inline-block">Add to Board</span>
        </button>
        <button *ngIf="userService.loggedIn()" mat-raised-button
                id="pinAllCdes" (click)="pinAllCdesIntoBoard()">
            <mat-icon>add_shopping_cart</mat-icon>
            <span class="d-none d-md-inline ml-1">Pin CDEs</span>
        </button>
        <button *ngIf="isOrgCurator(userService.user)" id="copyFormBtn" mat-raised-button
                (click)="openCopyElementModal()">
            <mat-icon>content_copy</mat-icon>
            <span class="d-none d-md-inline ml-1">Copy</span>
        </button>
        <button id="discussBtn" mat-raised-button (click)="commentMode = !commentMode">
            <mat-icon [ngClass]="{'faa-wrench faa-slow animated': hasComments && !commentMode}">comment
            </mat-icon>
            <span class="d-none d-md-inline ml-1">Discuss</span>
        </button>
        <span class="navbar-expand-md navbar-light">
            <button mat-raised-button class="navbar-toggler"
                    data-toggle="collapse" data-target="#leftNav" aria-controls="leftNav"
                    aria-label="Toggle navigation">
                <mat-icon>menu</mat-icon>
            </button>
        </span>
    </div>
    <div class="pull-right text-right">
        <ng-container *ngIf="elt.isDraft">
            {{savingText}}
            <button id="deleteDraftBtn" title="Delete Draft" mat-raised-button color="warn"
                    (click)="deleteModal.openDeleteModal()">
                <mat-icon>delete</mat-icon><span class="d-none d-sm-inline-block ml-1">Delete Draft</span>
            </button>
            <button id="openSave" mat-raised-button color="primary" (click)="publish()" [disabled]="savingText === 'Saving...'">
                <mat-icon>publish</mat-icon><span class="d-none d-sm-inline-block ml-1">Publish</span>
            </button>
        </ng-container>
    </div>
    <div class="clearfix"></div>
    <div class="pull-right text-right">
        <ng-container *ngIf="elt.isDraft">
            <span id="viewChangesBtn" class="fake-link hand-cursor" (click)="viewChanges();">Changed</span>
            by {{elt.updatedBy?.username}} on {{elt.updated | date: 'MM/dd/yyyy @ h:mma'}}
        </ng-container>
    </div>
    <div class="clearfix mb-1"></div>
    <div class="row">
        <div [ngClass]="{'col-9 eltCommentView':commentMode,'col-12':!commentMode}">
            <div class="row">
                <div class="col-xl-2 col-md-3 col-12 navbar-expand-md navbar-light">
                    <div id="leftNav" class="collapse navbar-collapse">
                        <ul class="list-group">
                            <a id="preview_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='preview_tab'}"
                               (click)="currentTab ='preview_tab'">Preview
                                <mat-icon *ngIf="tabsCommented.indexOf('preview_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                            <a id="general_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='general_tab'}"
                               (click)="currentTab ='general_tab'">General Detail
                                <mat-icon *ngIf="tabsCommented.indexOf('general_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                            <a id="description_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='description_tab'}"
                               (click)="currentTab ='description_tab'">Form Description
                                <mat-icon *ngIf="tabsCommented.indexOf('description_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                            <a id="naming_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='naming_tab'}"
                               (click)="currentTab ='naming_tab'">Naming
                                <mat-icon *ngIf="tabsCommented.indexOf('naming_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                            <a id="classification_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='classification_tab'}"
                               (click)="currentTab = 'classification_tab'">Classification
                                <mat-icon *ngIf="tabsCommented.indexOf('classification_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                            <a id="referenceDocuments_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='referenceDocuments_tab'}"
                               (click)="currentTab = 'referenceDocuments_tab'">Reference Documents
                                <mat-icon *ngIf="tabsCommented.indexOf('referenceDocuments_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                            <a id="displayProfiles_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='displayProfiles_tab'}"
                               (click)="currentTab = 'displayProfiles_tab'">Display Profiles
                                <mat-icon *ngIf="tabsCommented.indexOf('displayProfiles_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                            <a id="properties_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='properties_tab'}"
                               (click)="currentTab = 'properties_tab'">Properties
                                <mat-icon *ngIf="tabsCommented.indexOf('properties_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                            <a id="ids_tab" class="list-group-item" [ngClass]="{'active':currentTab ==='ids_tab'}"
                               (click)="currentTab = 'ids_tab'">Identifiers
                                <mat-icon *ngIf="tabsCommented.indexOf('ids_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                            <a id="attachments_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='attachments_tab'}"
                               (click)="currentTab = 'attachments_tab'">Attachments
                                <mat-icon *ngIf="tabsCommented.indexOf('attachments_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                            <a id="history_tab" class="list-group-item"
                               [ngClass]="{'active':currentTab ==='history_tab'}"
                               (click)="currentTab = 'history_tab'">History
                                <mat-icon *ngIf="tabsCommented.indexOf('history_tab') > -1"
                                   class="pull-right" aria-hidden="true">forum</mat-icon></a>
                        </ul>
                    </div>
                </div>
                <div id="middleView" class="col-xl-10 col-md-9 col-12">
                    <ng-container *ngIf="currentTab === 'preview_tab'">
                        <cde-native-render-full [elt]="elt"></cde-native-render-full>
                    </ng-container>
                    <ng-container *ngIf="currentTab === 'general_tab'">
                        <cde-form-general-details [elt]="elt" [canEdit]="canEdit()" (onEltChange)="saveDraft()">
                        </cde-form-general-details>
                        <cde-admin-item-sources [elt]="elt"></cde-admin-item-sources>
                        <cde-registration [elt]="elt" (onEltChange)="saveDraft()"
                                          [canEdit]="canEdit()"></cde-registration>
                        <cde-linked-boards [elt]="elt"></cde-linked-boards>
                        <cde-linked-forms [elt]="elt"></cde-linked-forms>
                        <cde-form-term-mapping [elt]="elt"></cde-form-term-mapping>
                    </ng-container>
                    <ng-container *ngIf="currentTab=== 'description_tab'">
                        <cde-form-description [(elt)]="elt" [canEdit]="canEdit()"
                                              (onEltChange)="saveDraft()"></cde-form-description>
                    </ng-container>
                    <ng-container *ngIf="currentTab=== 'naming_tab'">
                        <cde-naming [elt]="elt" [canEdit]="canEdit()" (onEltChange)="saveDraft();"></cde-naming>
                    </ng-container>
                    <ng-container *ngIf="currentTab=== 'classification_tab'">
                        <cde-form-classification [elt]="elt"></cde-form-classification>
                    </ng-container>
                    <ng-container *ngIf="currentTab=== 'referenceDocuments_tab'">
                        <cde-reference-document [elt]="elt" [canEdit]="canEdit()" (onEltChange)="saveDraft();">
                        </cde-reference-document>
                    </ng-container>
                    <ng-container *ngIf="currentTab=== 'displayProfiles_tab'">
                        <cde-display-profile [elt]="elt" [canEdit]="canEdit()" (onEltChange)="saveDraft();">
                        </cde-display-profile>
                    </ng-container>
                    <ng-container *ngIf="currentTab=== 'properties_tab'">
                        <cde-properties [elt]="elt" [canEdit]="canEdit()" (onEltChange)="saveDraft();">
                        </cde-properties>
                    </ng-container>
                    <ng-container *ngIf="currentTab=== 'ids_tab'">
                        <cde-identifiers [elt]="elt" [canEdit]="canEdit()" (onEltChange)="saveDraft();">
                        </cde-identifiers>
                    </ng-container>
                    <ng-container *ngIf="currentTab=== 'attachments_tab'">
                        <cde-attachments [elt]="elt" [canEdit]="canEdit()"
                                         (removeAttachment)="removeAttachment($event);"
                                         (setDefault)="setDefault($event);"
                                         (upload)="upload($event);"></cde-attachments>
                    </ng-container>
                    <ng-container *ngIf="currentTab=== 'history_tab'">
                        <cde-history [elt]="elt" [canEdit]="canEdit()"></cde-history>
                    </ng-container>
                </div>
            </div>
        </div>
        <div *ngIf="commentMode" [ngClass]="{'col-3':commentMode,'':!commentMode}"
             style="padding-left:10px;box-shadow: inset 10px 0 5px -2px #888;background-color: #f5f5f5;">
            <cde-discuss-area #commentAreaComponent [currentTab]="currentTab" [elt]="elt"
                              (highlightedTabsChange)="loadHighlightedTabs($event)"
                              [eltName]="elt.designations[0].designation"></cde-discuss-area>
        </div>
    </div>
    <cde-save-modal #saveModal [elt]="elt" (save)="saveForm()" (onEltChange)="saveDraft()"></cde-save-modal>
    <cde-delete-modal #deleteModal (confirm)="removeDraft()"></cde-delete-modal>
</div>

<ng-template #copyFormContent id="copyFormModal">
    <h4 mat-dialog-title>Create a copy</h4>
    <div mat-dialog-content>
        <p class="text-info">You are about to create a new CDE/Form by duplicating this one. Please specify a new name
            and a classification of the CDE/Form.</p>
        <cde-create-form [elt]="eltCopy" (done)="dialogRef.close()"></cde-create-form>
    </div>
</ng-template>

<ng-template #exportPublishModal id="publishFormModal">
    <h3 mat-dialog-title="">Export to a Published Form</h3>
    <form #createPublishedForm="ngForm">
        <div mat-dialog-content>
            <p class="text-info">This export will generate a published version of this form that will submit data to
                the endpoint of your choice. Note that the NIH CDE Repository will not have access to any of the
                submitted.
                You will need to ensure that your endpoint meets your own security standards. A sample endpoint could be
                a Google Spreadsheet (via a Google Script published as a web app).
            </p>
            To get started, please follow these steps:
            <div class="form-group">
                <label for="publishedFormUrl">Copy paste that URL here:</label>
                <input type="url" class="form-control" id="publishedFormUrl" [(ngModel)]="formInput.endpointUrl"
                       name="publishedFormUrl" #endpointUrl="ngModel" required>
                <p *ngIf="endpointUrl.errors">Not a valid URL.</p>
                <p>Your published forms will appear in your profile.</p>
            </div>
            <div class="form-group">
                <label for="publishedFormName">Give your published form a name so you can find it more easily.</label>
                <input class="form-control" id="publishedFormName" [(ngModel)]="formInput.publishedFormName"
                       name="publishedFormName" required>
                Click "Publish my form" below and write down the final URL. This is the url you will open to start
                recording your data.
            </div>
        </div>
        <div mat-dialog-actions>
            <button mat-raised-button color="accent" [mat-dialog-close] id="cancelExport">Cancel</button>
            <button mat-raised-button color="primary" (click)="exportPublishForm()" id="goExport"
                    [disabled]="!createPublishedForm.form.valid">Publish my form.
            </button>
        </div>
    </form>
</ng-template>

<cde-pin-board-modal #mltPinModal module="form"></cde-pin-board-modal>
<cde-pin-board-modal #mltPinModalCde module="cde"></cde-pin-board-modal>
