<div *ngIf="!elt">
    <h1 class="pt60 pb40 text-center">
        <i class="fa fa-spinner fa-pulse"></i>Loading...
    </h1>
</div>

<div *ngIf="elt" class="container-fluid" itemscope="http://schema.org/MedicalCode">
    <div *ngIf="elt.archived" class="alert alert-warning mt20" role="alert">
        <i class="fa fa-exclamation-triangle"></i>
        <strong>Warning:</strong> this form is archived. You can
        <a id="viewCurrentEltLink" href="/formView?tinyId={{elt.tinyId}}">view the current version here</a>.
    </div>
    <div *ngIf="elt.registrationState.registrationStatus=='Retired'" class="alert alert-warning mt20" role="alert">
        <i class="fa fa-exclamation-triangle"></i>
        <strong>Warning:</strong> this form is retired.
        <a *ngIf="elt.registrationState.replacedBy"
           href="/deView?tinyId={{elt.registrationState.replacedBy.tinyId}}">Replacement</a>
    </div>
    <div class="alert alert-info mt20" role="alert" *ngIf="elt.outdated">
        <i class="fa fa-exclamation-triangle"></i>
        <strong>Note: </strong>Some CDEs in this form have newer version.
    </div>
    <div class="alert alert-warning mt20" role="alert" *ngIf="missingCdes.length > 0">
        <i class="fa fa-exclamation-triangle"></i>
        The following CDEs are part of a score but are missing from this form:
        <ul class="list-inline">
            <li *ngFor="let missCde of missingCdes;let i = index;">
                <a href="/deView?tinyId={{missCde.tinyId}}" target="_blank">CDE {{i+1}},id: {{missCde.tinyId}}</a>
                <span *ngIf="i < missingCdes.length">,</span></li>
        </ul>
    </div>
    <div *ngIf="elt.registrationState.administrativeStatus=='Retire Candidate'" class="alert alert-warning mt20"
         role="alert">
        <i class="fa fa-exclamation-triangle"></i>
        <strong>Warning:</strong> this form is about to be retired.
        <a *ngIf="elt.registrationState.replacedBy"
           href="/deView?tinyId={{elt.registrationState.replacedBy.tinyId}}">Possible Replacement</a>
    </div>
    <div *ngIf="elt.forkOf" class="alert alert-info mt20" role="alert">
        <i class="fa fa-exclamation-triangle"></i>
        You are editing a fork. <a href="/deView?cdeId={{rootFork._id}}">
        <i class="fa fa-eye"></i> View Original</a>. To remove a fork, Retire it.
    </div>
    <div class="row">
        <div [ngClass]="{'col-sm-9 eltCommentView':commentMode,'col-sm-12':!commentMode}">
             <!--[style.background-color]="elt.isDraft ? '#d9edf7' : 'transparent'">-->
            <h1 class="page-header">
                <span *ngIf="elt.isDraft" class="label label-info">DRAFT</span> {{elt.naming[0].designation}}
                <button *ngIf="quickBoardService.canAddElement(elt)" id="addToQuickBoard"
                        class="btn btn-small btn-default"
                        title="Add to Compare List" type="button" (click)="quickBoardService.addToQuickBoard(elt)">
                    <i class="fa fa-plus"></i> Add to Quick Board
                </button>
                <button id="addToBoard" class="btn btn-small btn-default" title="Add to Board"
                        type="button" (click)="mltPinModal.open([elt], 'cde')">
                    <i class="fa fa-thumb-tack"></i> Add to Board
                </button>
                <div class="btn-group" role="group">
                    <button id="export" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-download"></i> Export <span class="caret"></span>
                    </button>
                    <div class="dropdown-menu" aria-labelledby="export">
                        <ng-container *ngIf="isAllowedModel.loggedIn()">
                            <li>
                                <a id='nihJson' href="formById/{{elt._id}}" target="_blank" style="display: inline">JSON
                                    File, NIH/CDE Schema</a>
                                <a href="/schema/form" target="_blank" style="display: inline">
                                    <i class="fa fa-info-circle"></i></a>
                            </li>
                            <li>
                                <a id='odmExport' href="formById/{{elt._id}}?type=xml&subtype=odm" target="_blank"
                                   style="display: inline">XML File, CDISC / ODM</a>
                                <a href="https://www.cdisc.org/standards/transport/odm" target="_blank"
                                   style="display: inline">
                                    <i class="fa fa-info-circle"></i></a>
                            </li>
                            <li>
                                <a id='sdcExport' href="formById/{{elt._id}}?type=xml&subtype=sdc" target="_blank"
                                   style="display: inline">XML File, SDC Schema</a>
                                <a href="https://github.com/esacinc/sdc-schema-package" target="_blank"
                                   style="display: inline"><i class="fa fa-info-circle"></i></a>
                            </li>
                            <li>
                                <a class="dropdown-item" *ngIf="!isIe()" id='sdcHtmlExport'
                                   href="formById/{{elt._id}}?type=xml&subtype=sdc&renderer=defaultHtml"
                                   target="_blank">XML File, SDC Schema with XSL Transform</a>
                            </li>
                            <li><a class="dropdown-item" id='nihXml' href="formById/{{elt._id}}?type=xml"
                                   target="_blank">XML File, NIH/CDE Schema</a>
                            </li>
                            <li>
                                <a class="dropdown-item" id='formPublishExport' (click)="openPreparePublishModal()"
                                   target="_blank">Published Form</a>
                            </li>
                            <li>
                                <a class="dropdown-item" id='nihRedCap' href="formById/{{elt._id}}?type=REDCap"
                                   target="_blank" style="display: inline">REDCap</a>
                                <a href="https://projectredcap.org/" target="_blank" style="display: inline">
                                    <i class="fa fa-info-circle"></i></a>
                            </li>
                        </ng-container>
                        <a class="dropdown-item" *ngIf="!isAllowedModel.loggedIn()" href="login">
                            Please login to export forms.</a>
                    </div>
                </div>
                <button *ngIf="isAllowedModel.loggedIn()" id="pinAllCdes" class="btn btn-small btn-default"
                        target="_blank" title="Pin CDEs" (click)="pinAllCdesIntoBoard()">
                    <i class="fa fa-cogs"></i> Pin CDEs
                </button>
                <button *ngIf="isAllowedModel.loggedIn()" id="copyFormBtn" class="btn btn-small btn-default"
                        (click)="openCopyElementModal()" title="Copy CDE" type="button">
                    <i class="fa fa-clone"></i> Copy
                </button>

                <button id="discussBtn" class="btn btn-small btn-default" role="button" title="Discuss CDE"
                        type="button" (click)="commentMode = !commentMode;">
                    <i class="fa fa-comment" [ngClass]="{discussWrench: hasComments && !commentMode}"></i> Discuss
                </button>

                <span class="pull-right">
                <ng-container *ngIf="isAllowedModel.isAllowed(elt)">
                    <ng-container *ngIf="drafts.length > 0">
                        <button *ngIf="!elt.isDraft" (click)="loadDraft(null);" class="btn btn-info">
                            <i class="fa fa-eye fa-lg"></i> View Draft</button>
                    </ng-container>
                </ng-container>
                <ng-container *ngIf="elt.isDraft">
                        <button class="btn btn-info" (click)="elt.isDraft = false">
                            <i class="fa fa-eye fa-lg"></i> View Published</button>
                        <button class="btn btn-success">
                            <i class="fa fa-globe fa-lg"></i> Publish</button>
                        <button class="btn btn-danger">
                            <i class="fa fa-trash fa-lg"></i> Delete Draft</button>
                </ng-container>
                </span>
            </h1>
            <div [style.background-color]="elt.isDraft ? 'white' : 'transparent'" style="margin-bottom: 10px">
                <ngb-tabset (tabChange)="beforeChange($event)">
                    <ngb-tab id="general_tab">
                        <ng-template ngbTabTitle>
                            <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('general') !== -1}">
                                General Details
                            </div>
                        </ng-template>
                        <ng-template ngbTabContent>
                            <cde-form-general-details [elt]="elt" [canEdit]="canEdit" (save)="doStageElt()">
                            </cde-form-general-details>
                        </ng-template>
                    </ngb-tab>
                    <ngb-tab id="description_tab">
                        <ng-template ngbTabTitle>
                            <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('description') !== -1}">
                                Form Description
                            </div>
                        </ng-template>
                        <ng-template ngbTabContent>
                            <cde-form-description [cache]="cache" [elt]="elt" [canEdit]="canEdit"
                                                  [inScoreCdes]="inScoreCdes"
                                                  (isFormValid)="setIsValid($event)"
                                                  (onEltChange)="doStageElt()"></cde-form-description>
                        </ng-template>
                    </ngb-tab>
                    <ngb-tab id="naming_tab">
                        <ng-template ngbTabTitle>
                            <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('naming') !== -1}">
                                Naming
                            </div>
                        </ng-template>
                        <ng-template ngbTabContent>
                            <ng-template ngbTabTitle>
                                <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('naming') !== -1}"></div>
                            </ng-template>
                            <cde-naming [elt]="elt" [canEdit]="canEdit" (onEltChange)="doStageElt();"></cde-naming>
                        </ng-template>
                    </ngb-tab>
                    <ngb-tab id="classification_tab">
                        <ng-template ngbTabTitle>
                            <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('classification') !== -1}">
                                Classification
                            </div>
                        </ng-template>
                        <ng-template ngbTabContent>
                            <cde-form-classification [elt]="elt"></cde-form-classification>
                        </ng-template>
                    </ngb-tab>
                    <ngb-tab id="referenceDocuments_tab">
                        <ng-template ngbTabTitle>
                            <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('referenceDocuments') !== -1}">
                                Reference Documents
                            </div>
                        </ng-template>
                        <ng-template ngbTabContent>
                            <cde-reference-document [elt]="elt" [canEdit]="canEdit" (onEltChange)="doStageElt();">
                            </cde-reference-document>
                        </ng-template>
                    </ngb-tab>
                    <ngb-tab id="displayProfiles_tab">
                        <ng-template ngbTabTitle>
                            <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('displayProfiles') !== -1}">
                                Display Profiles
                            </div>
                        </ng-template>
                        <ng-template ngbTabContent>
                            <cde-display-profile [elt]="elt" [canEdit]="canEdit" (onEltChange)="doStageElt();">
                            </cde-display-profile>
                        </ng-template>
                    </ngb-tab>

                    <ngb-tab id="properties_tab">
                        <ng-template ngbTabTitle>
                            <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('properties') !== -1}">
                                Properties
                            </div>
                        </ng-template>
                        <ng-template ngbTabContent>
                            <cde-properties [elt]="elt" [canEdit]="canEdit" (onEltChange)="doStageElt();">
                            </cde-properties>
                        </ng-template>
                    </ngb-tab>
                    <ngb-tab id="ids_tab">
                        <ng-template ngbTabTitle>
                            <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('ids') !== -1}">
                                Identifiers
                            </div>
                        </ng-template>
                        <ng-template ngbTabContent>
                            <cde-identifiers [elt]="elt" [canEdit]="canEdit" (onEltChange)="doStageElt();">
                            </cde-identifiers>
                        </ng-template>
                    </ngb-tab>
                    <ngb-tab id="attachments_tab">
                        <ng-template ngbTabTitle>
                            <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('attachments') !== -1}">
                                Attachments
                            </div>
                        </ng-template>
                        <ng-template ngbTabContent>
                            <cde-attachments [elt]="elt" [canEdit]="canEdit" (removeAttachment)="removeAttachment($event);"
                                             (setDefault)="setDefault($event);"
                                             (upload)="upload($event);"></cde-attachments>
                        </ng-template>
                    </ngb-tab>
                    <ngb-tab id="history_tab">
                        <ng-template ngbTabTitle>
                            <div [ngClass]="{'highlightedTab':commentMode && highlightedTabs.indexOf('history') !== -1}">
                                History
                            </div>
                        </ng-template>
                        <ng-template ngbTabContent>
                            <cde-history [elt]="elt" [canEdit]="canEdit"></cde-history>
                        </ng-template>
                    </ngb-tab>
                </ngb-tabset>
            </div>
        </div>
        <div *ngIf="commentMode" [ngClass]="{'col-sm-3':commentMode,'':!commentMode}"
             style="padding-left:10px;box-shadow: inset 10px 0 5px -2px #888;background-color: #f5f5f5;">
            <cde-discuss-area #commentAreaComponent [selectedElt]="currentTab" [eltId]="elt.tinyId" [elt]="elt"
                              (highlightedTabsChange)="loadHighlightedTabs($event)"
                              [eltName]="elt.naming[0].designation"></cde-discuss-area>
        </div>
    </div>
    <cde-save-modal #saveModal [elt]="elt" (save)="stageForm();"></cde-save-modal>
</div>

<ng-template #copyFormContent id="copyFormModal" let-c="close" let-d="dismiss">
    <div class="modal-header" id="copyFormModalHeader">
        <h4 class="modal-title">Create a copy</h4>
    </div>
    <div class="modal-body" id="copyFormModalBody">
        <p class="text-info">You are about to create a new CDE/Form by duplicating this one. Please specify a new name
            and a classification of the CDE/Form.</p>
        <cde-create-form [elt]="eltCopy" (cancel)="closeCopyFormModal()"></cde-create-form>
    </div>
</ng-template>

<ng-template #publishFormContent id="publishFormModal" let-c="close" let-d="dismiss">
    <form #createPublishedForm="ngForm">
        <div class="modal-header" id="publishFormModalHeader">
            <h3>Export to a Published Form</h3>
        </div>
        <div class="modal-body" id="publishFormModalBody">
            <p class="text-info">This export will generate a published version of this form that will submit data to
                the endpoint of your choice. Note that the NIH CDE Repository will not have access to any of the
                submitted.
                You will need to ensure that your endpoint meets your own security standards. A sample endpoint could be
                a
                Google Spreadsheet (via a Google Script published as a web app).
            </p>
            To get started, please follow these steps:
            <div class="form-group">
                <label for="publishedFormUrl">Copy paste that URL here:</label>
                <input type="url" class="form-control" id="publishedFormUrl" [(ngModel)]="formInput.endpointUrl"
                       name="publishedFormUrl" #endpointUrl="ngModel" required>
                <p *ngIf="endpointUrl.errors">Not a valid URL.</p>
                <p>Your published forms will appear in your profile.</p>
            </div>
            <div class="form-group">
                <label for="publishedFormName">Give your published form a name so you can find it more easily.</label>
                <input class="form-control" id="publishedFormName" [(ngModel)]="formInput.publishedFormName"
                       name="publishedFormName" required>
                Click "Publish my form" below and write down the final URL. This is the url you will open to start
                recording your data.
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-warning" (click)="c()" id="cancelExport">Cancel</button>
            <button class="btn btn-success" (click)="publishForm(formInput)" id="goExport"
                    [disabled]="!createPublishedForm.form.valid">Publish my form.
            </button>
        </div>
    </form>
</ng-template>

<cde-pin-board-modal #mltPinModal module="form"></cde-pin-board-modal>
<cde-pin-board-modal #mltPinModalCde module="cde"></cde-pin-board-modal>
