<div class="container-fluid" ng-cloak>
    <div ng-controller="VersionCtrl" class="alert alert-info mt20" ng-show="elt.unsaved" id="openSaveTop">
        <i class="fa fa-exclamation-triangle"></i> This element is not saved.
        <span ng-if="!isFormValid"> Some errors need to be be fixed before the form can be saved.</span>
        <button ng-disabled="!isFormValid" class="btn btn-primary" ng-click="openSave(elt, 'formView?tinyId=')"
                id="openSave">
            Save
        </button>
    </div>
    <div class="alert alert-warning mt20" role="alert" ng-show="elt.archived">
        <i class="fa fa-exclamation-triangle"></i> <strong>Warning:</strong> this form is archived.
        <a id="viewCurrentEltLink" href="/formView?tinyId={{elt.tinyId}}">View current form</a>
    </div>

    <div class="alert alert-warning mt20" role="alert" ng-show="elt.registrationState.registrationStatus=='Retired'">
        <i class="fa fa-exclamation-triangle"></i> <strong>Warning:</strong> this form is retired.
        <span ng-show="elt.registrationState.replacedBy">
            <a href="/formView?tinyId={{elt.registrationState.replacedBy.tinyId}}">Replacement</a>
        </span>
    </div>
    <div class="alert alert-info mt20" role="alert" ng-show="elt.outdated"><i class="fa fa-exclamation-triangle"></i>
        <strong>Note: </strong>Some CDEs in this form have newer version.
    </div>
    <div class="alert alert-warning mt20" role="alert" ng-if="missingCdes.length > 0">
        <i class="fa fa-exclamation-triangle"></i>
        The following CDEs are part of a score but are missing from this form:
        <ul class="list-inline">
            <li ng-repeat="mc in missingCdes">
                <a href="/deview?tinyId={{mc.tinyId}}" target="_blank">CDE {{$index+1}},id: {{mc.tinyId}}</a>
                <span ng-if="!$last">,</span></li>
        </ul>
    </div>
    <div class="row">
    <div ng-class="{'col-sm-9 eltCommentView':commentMode,'col-sm-12':!commentMode}">
        <h3 class="mt-5">{{elt.naming[0].designation}}
            <a class="btn btn-small btn-default" ng-show="formQuickBoard.canAddElt(elt)" role="button"
               ng-click="formQuickBoard.add(elt)" title="Add to Compare List" id="addToQuickBoard">
                <i class="fa fa-plus"></i> Add to Quick Board</a>
            <a class="btn btn-small btn-default" role="button"
               ng-click="formPinModal.openPinModal(elt)" title="Add to Board" id="addToBoard">
                <i class="fa fa-thumb-tack"></i> Add to Board</a>

            <div class="btn-group" ng-if="elt.tinyId">
                <button id="export" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-download"></i>
                    Export <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li ng-if="user._id">
                        <a id='nihJson' ng-href="form/{{elt._id}}" target="_blank">JSON File, NIH/CDE Schema</a>
                    </li>
                    <li ng-if="user._id">
                        <a id='odmExport' ng-href="form/{{elt._id}}?type=xml&subtype=odm" target="_blank">XML File,
                            ODM Schema</a>
                    </li>
                    <li ng-if="user._id">
                        <a id='sdcExport' ng-href="form/{{elt._id}}?type=xml&subtype=sdc" target="_blank">
                            XML File, SDC Schema</a>
                    </li>
                    <li ng-if="user._id && !isIe()">
                        <a id='sdcHtmlExport' ng-href="form/{{elt._id}}?type=xml&subtype=sdc&renderer=defaultHtml" target="_blank">
                            XML File, SDC Schema with XSL Transform</a>
                    </li>
                    <li ng-if="user._id">
                        <a id='nihXml' ng-href="form/{{elt._id}}?type=xml" target="_blank">XML File, NIH/CDE
                            Schema</a>
                    </li>
                    <li ng-if="user._id">
                        <a id='formPublishExport' ng-click="preparePublishExport()" target="_blank">Published Form</a>
                    </li>
                    <li ng-if="user._id">
                        <a id='nihRedCap' ng-href="form/{{elt._id}}?type=REDCap" target="_blank">
                            REDCap</a>
                    </li>
                    <li ng-if="!user._id"><a href="login">Please login to export forms.</a></li>
                </ul>
            </div>

            <button class="btn btn-small btn-default" target="_blank" title="Pin CDEs" id="pinAllCdes"
                    ng-if="user._id" ng-click="pinAllCdesModal()">
                <i class="fa fa-cogs"></i> Pin CDEs
            </button>

            <button class="btn btn-small btn-default" role="button"  ng-if="user._id && user.orgAdmin.length > 0"
                    ng-click="copyElt()" title="Copy Form" id="copyFormBtn">
                <i class="fa fa-clone"></i> Copy
            </button>

            <button class="btn btn-small btn-default" role="button"  ng-controller="HasCommentsCtrl"
                    ng-click="switchCommentMode()" title="Discuss Form" id="discussBtn">
                <i class="fa fa-comment" ng-class="{discussWrench: hasComments && !commentMode}"></i> Discuss
            </button>
        </h3>

        <uib-tabset ng-if="elt" active="currentTab">

            <uib-tab id="general_tab" index="'general'" select="setCurrentTab('general')">
                <uib-tab-heading ng-class="{'{{tab.class}}':tab.class,'highlightedTab':commentMode && tab.highlight}">
                    General Details
                </uib-tab-heading>
                <div ng-if="currentTab === 'general'">
                    <cde-form-general-details [elt]="elt"></cde-form-general-details>
                </div>
            </uib-tab>

            <uib-tab id="description_tab" index="'description'" select="setCurrentTab('description')">
                <uib-tab-heading ng-class="{'{{tab.class}}':tab.class,'highlightedTab':commentMode && tab.highlight}">
                    Form Description
                </uib-tab-heading>
                <div ng-if="currentTab === 'description'">
                    <cde-form-description [cache]="cache" [elt]="elt" [inScoreCdes]="inScoreCdes"
                                          (cachePut)="cachePut($event)" (isFormValid)="setIsValid($event)"
                                          ></cde-form-description>
                </div>
            </uib-tab>

            <uib-tab id="naming_tab" index="'naming'" select="setCurrentTab('naming')">
                <uib-tab-heading ng-class="{'{{tab.class}}':tab.class,'highlightedTab':commentMode && tab.highlight}">
                    Naming
                </uib-tab-heading>
                <div ng-if="currentTab === 'naming'">
                    <cde-admin-item-naming [elt]="elt"></cde-admin-item-naming>
                </div>
            </uib-tab>

            <uib-tab id="classification_tab" index="'classification'"select="setCurrentTab('classification')">
                <uib-tab-heading ng-class="{'{{tab.class}}':tab.class,'highlightedTab':commentMode && tab.highlight}">
                    Classification
                </uib-tab-heading>
                <div ng-if="currentTab === 'classification'">
                    <cde-admin-item-classification [elt]="elt"></cde-admin-item-classification>
                </div>
            </uib-tab>

            <uib-tab id="referenceDocument_tab" index="'referenceDocument'" select="setCurrentTab('referenceDocument')">
                <uib-tab-heading ng-class="{'{{tab.class}}':tab.class,'highlightedTab':commentMode && tab.highlight}">
                    Reference Documents
                </uib-tab-heading>
                <div ng-if="currentTab === 'referenceDocument'">
                    <cde-admin-item-reference-document [elt]="elt"></cde-admin-item-reference-document>
                </div>
            </uib-tab>

            <uib-tab id="displayProfiles_tab" index="'displayProfiles'" select="setCurrentTab('displayProfiles')">
                <uib-tab-heading ng-class="{'{{tab.class}}':tab.class,'highlightedTab':commentMode && tab.highlight}">
                    Display Profiles
                </uib-tab-heading>
                <div ng-if="currentTab === 'displayProfiles'">
                    <cde-form-display-profile [elt]="elt"></cde-form-display-profile>
                </div>
            </uib-tab>

            <uib-tab id="properties_tab" index="'properties'" select="setCurrentTab('properties')">
                <uib-tab-heading ng-class="{'{{tab.class}}':tab.class,'highlightedTab':commentMode && tab.highlight}">
                    Properties
                </uib-tab-heading>
                <div ng-if="currentTab === 'properties'">
                    <cde-admin-item-properties [elt]="elt"></cde-admin-item-properties>
                </div>
            </uib-tab>

            <uib-tab id="ids_tab" index="'ids'" select="setCurrentTab('ids')">
                <uib-tab-heading ng-class="{'{{tab.class}}':tab.class,'highlightedTab':commentMode && tab.highlight}">
                    Identifiers
                </uib-tab-heading>
                <div ng-if="currentTab === 'ids'">
                    <cde-admin-item-ids [elt]="elt"></cde-admin-item-ids>
                </div>
            </uib-tab>

            <uib-tab id="attachments_tab" index="'attachments'" select="setCurrentTab('attachments')">
                <uib-tab-heading ng-class="{'{{tab.class}}':tab.class,'highlightedTab':commentMode && tab.highlight}">
                    Attachments
                </uib-tab-heading>
                <div ng-if="currentTab === 'attachments'">
                    <cde-admin-item-attachments [elt]="elt"></cde-admin-item-attachments>
                </div>
            </uib-tab>

            <uib-tab id="attachments_tab" index="'history'" select="setCurrentTab('history')">
                <uib-tab-heading ng-class="{'{{tab.class}}':tab.class,'highlightedTab':commentMode && tab.highlight}">
                    History
                </uib-tab-heading>
                <div ng-if="currentTab === 'history'">
                    <cde-admin-item-history [elt]="elt"></cde-admin-item-history>
                </div>
            </uib-tab>

        </uib-tabset>
    </div>
    <div ng-if="commentMode" ng-class="{'col-sm-3':commentMode,'':!commentMode}"
         style="padding-left:10px;box-shadow: inset 10px 0 5px -2px #888;background-color: #f5f5f5;">
        Current tab: {{currentTab}}
        <cde-discuss-area [selected-elt]="currentTab" [elt-id]="elt.tinyId" [elt]="elt"
                          [elt-name]="elt.naming[0].designation"></cde-discuss-area>
    </div>
    </div>
    <div class="row" ng-controller="VersionCtrl">
        <div class="col-xs-12" ng-show="elt.unsaved">
            <hr/>
            <button class="btn cancel" ng-click="revert()" id="discardChanges">Discard Changes</button>
            <button ng-disabled="!isFormValid" class="btn btn-primary" ng-click="openSave(elt, 'formView?tinyId=')"
                    id="openSaveBottom">Save
            </button>
        </div>
    </div>
</div>
