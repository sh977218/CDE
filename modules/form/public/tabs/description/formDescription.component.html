<div *ngIf="elt" id="descriptionDiv" class="row">
    <div class="col-12">
        <div class="descriptionToolbox" *ngIf="canEdit" #descToolbox>
            <span style="color: white; font-weight: 700;margin-right: 5px">Add</span>
            <span role="button" id="addSectionTop" class="btn btn-light formDescriptionTool"
                  (dragstart)="dragActive = true" (dragend)="dragActive = false"
                  [treeDrag]="{ref:'section'}" [treeDragEnabled]="true"
                  style="width: 74px;">
                <i class="fa fa-plus"></i><span class="toolSection"></span>
            </span>
            <span *ngIf="elt.formElements.length > 0" role="button" id="startAddingQuestions"
                  class="btn btn-light formDescriptionTool"
                  (dragstart)="dragActive = true" (dragend)="dragActive = false"
                  [treeDrag]="{ref: 'question'}" [treeDragEnabled]="true"
                  style="width: 87px;">
                <i class="fa fa-cube"></i><span class="toolQuestion"></span>
            </span>
            <span *ngIf="elt.formElements.length > 0" role="button" id="startAddingForms"
                  class="btn btn-light formDescriptionTool"
                  (dragstart)="dragActive = true" (dragend)="dragActive = false"
                  [treeDrag]="{ref: 'form'}" [treeDragEnabled]="true"
                  style="width: 68px;">
                <i class="fa fa-cubes"></i><span class="toolForm"></span>
            </span>
            <span role="button" *ngIf="hasCopiedSection()" id="pasteSection"
                  class="btn btn-light formDescriptionTool"
                  (dragstart)="dragActive = true" (dragend)="dragActive = false"
                  [treeDrag]="{ref: 'pasteSection'}" [treeDragEnabled]="true" style="width: 68px;">
                <i class="fa fa-paste" [ngClass]="{'pasteSectionWrench':elt.isCopied}"></i><span
                    class="toolCopySection"></span>
            </span>
        </div>
        <div *ngIf="elt.formElements.length === 0">
            <span *ngIf="elt.noRenderAllowed">
                <i class="fa fa-exclamation-triangle"></i>
                Rendering is disabled for this form.
            </span>
            <h2 *ngIf="!elt.noRenderAllowed" style="margin: auto; max-width: 600px">
                <ng-container *ngIf="canEdit">
                    <i class="fa fa-info-circle"></i>
                    To begin building your form, find the Section button in the upper right corner
                    of your screen and drag it below .
                </ng-container>
                <ng-container *ngIf="!canEdit">
                    This form has no content.
                </ng-container>
            </h2>
        </div>

        <ng-container *ngFor="let eltIter of [elt]">
            <tree-root [ngClass]="{'drag-active': dragActive}"
                    #tree [nodes]="eltIter.formElements" [options]="treeOptions" style="min-height: 400px">
                <ng-template #treeNodeFullTemplate let-node let-index="index" let-templates="templates">
                    <div class="tree-node tree-node-level-{{ node.level }}" [id]="node.data.elementType + '_' + node.data.feId"
                         [class]="node.getClass()"
                         [class.tree-node-expanded]="node.isExpanded && node.hasChildren"
                         [class.tree-node-collapsed]="node.isCollapsed && node.hasChildren"
                         [class.tree-node-leaf]="node.isLeaf"
                         [class.tree-node-active]="node.isActive"
                         [class.tree-node-focused]="node.isFocused">
                        <tree-node-drop-slot *ngIf="index === 0" [dropIndex]="node.index"
                                             [node]="node.parent"></tree-node-drop-slot>
                        <div class="card" [@copySection]="node.data.isCopied">
                            <div class="card-header">
                                <div class="node-wrapper" [style.padding-left]="node.getNodePadding()">
                                    <div class="node-content-wrapper w-100"
                                         (click)="node.mouseAction('click', $event)"
                                         (dblclick)="node.mouseAction('dblClick', $event)"
                                         (contextmenu)="node.mouseAction('contextMenu', $event)"
                                         (treeDrop)="node.onDrop($event)"
                                         [treeAllowDrop]="node.allowDrop">
                                        <cde-form-description-section
                                                *ngIf="node.data.elementType === 'section' || node.data.elementType === 'form'"
                                                [elt]="elt" [canEdit]="canEdit" [node]="node" [index]="index"
                                                (onEltChange)="onEltChange.emit()"></cde-form-description-section>
                                        <cde-form-description-question
                                                *ngIf="node.data.elementType === 'question'"
                                                [elt]="elt" [canEdit]="canEdit" [node]="node" [index]="index"
                                                (stageElt)="onEltChange.emit()"></cde-form-description-question>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body" [ngClass]="{'panel-body-form': node.data.elementType === 'form'}">
                                <tree-node-children [node]="node" [templates]="templates"></tree-node-children>
                                <div *ngIf="node.data.elementType === 'form' && !node.data.expanded"
                                     (click)="node.data.expanded = true; node.expand()"
                                     class="btn btn-outline-dark expand-form">
                                    <i class="fa fa-chevron-right" aria-hidden="true"></i> Expand
                                </div>
                                <cde-form-description-question-detail *ngIf="node.data.elementType === 'question'"
                                                                      [elt]="elt" [node]="node"
                                                                      [canEdit]="canEdit"
                                                                      (onEltChange)="onEltChange.emit();">
                                </cde-form-description-question-detail>
                            </div>
                        </div>
                        <tree-node-drop-slot [dropIndex]="node.index + 1" [node]="node.parent"></tree-node-drop-slot>
                    </div>
                </ng-template>
            </tree-root>
        </ng-container>
    </div>
</div>


<ng-template #formSearchTmpl let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h3>Search Forms</h3>
    </div>
    <div class="modal-body">
        <cde-form-search class="panel-group" id="accordion_form" addMode="True" [embedded]="true"
                         (add)="addFormFromSearch($event)">
        </cde-form-search>
    </div>
    <div class="modal-footer">
        <button class="btn  btn-warning" (click)="d()" id="cancelSelectF">Close</button>
    </div>
</ng-template>

<ng-template #questionSearchTmpl let-c="close" let-d="dismiss">
    <ng-container *ngIf="questionModelMode === 'search'">
        <div class="modal-header">
            <h1>Search Data Elements</h1>
            <button class="btn btn-outline-dark" id="addNewCdeBtn" (click)="questionModelMode = 'add'">
                Create Data Element
            </button>
        </div>
        <div class="modal-body">
            <cde-cde-search addMode="True" [embedded]="true" (add)="addQuestionFromSearch($event)">
            </cde-cde-search>
        </div>
        <div class="modal-footer">
            <button class="btn  btn-warning" (click)="d()" id="cancelSelectQ">Close</button>
        </div>
    </ng-container>
    <ng-container *ngIf="questionModelMode === 'add'">
        <form #newDataElementForm="ngForm" (ngSubmit)="createNewDataElement(undefined,c);">
            <div class="modal-header">
                <h1>Create Data Element</h1>
                <button class="btn btn-outline-dark" type="button" (click)="questionModelMode = 'search'">
                    Search Data Elements
                </button>
            </div>
            <div class="modal-body">
                <label for="newDEName"></label>
                <input [(ngModel)]="newDataElement.designations[0].designation" class="form-control" id="newDEName"
                       name="newDEName" placeholder="New Data Element Name"
                       (ngModelChange)="newDataElementNameChanged();"
                       required autofocus/>
                <div id="accordionList" *ngIf="suggestedCdes?.length > 0">
                    <h4>Possible Matches</h4>
                    <div class="card" *ngFor="let cde of suggestedCdes;let index = index;">
                        <div class="card-header">
                            <button class="btn btn-outline-danger hand-cursor" type="button"
                                    (click)="createNewDataElement(cde,c);">
                                <i class="fa fa-plus"></i> Add
                            </button>
                            <span class="hand-cursor" (click)="cde.isCollapsed = !cde.isCollapsed">
                                {{cde.designations[0].designation}}
                            </span>
                            <a routerLink="/deView" [queryParams]="{tinyId: cde.tinyId}" target="_blank">
                                <i class="fa fa-eye iconColor"></i></a>
                            <cde-pin-board [elt]="cde" [eltIndex]="index" [module]="'cde'"></cde-pin-board>
                            <cde-pin-quickboard [elt]="cde" [eltIndex]="index"></cde-pin-quickboard>
                        </div>
                        <div class="card-body" [ngbCollapse]="!cde.isCollapsed">
                            <div class="row">
                                <div class="col-12">
                                    {{cde.definitions[0].definition}}
                                </div>
                            </div>
                            <div class="row" *ngIf="cde.valueDomain.permissibleValues.length > 0">
                                <div class="col-12">
                                    <table class="table table-bordered">
                                        <tr>
                                            <th>Value</th>
                                            <th>Code Name</th>
                                            <th>Code</th>
                                        </tr>
                                        <tr *ngFor="let pv of cde.valueDomain.permissibleValues">
                                            <td>{{pv.permissibleValue}}</td>
                                            <td>{{pv.valueMeaningName}}
                                            <td>{{pv.valueMeaningCode}}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" type="submit" [disabled]="!newDataElementForm.valid"
                        id="createNewDataElement">Create
                </button>
            </div>
        </form>
    </ng-container>
</ng-template>
