<ng-template [ngTemplateOutlet]="getTemplate()" [ngTemplateOutletContext]="{ $implicit: question }"></ng-template>

<ng-template #formDescriptionQuestionTmpl>
    <div class="my-1">
        <span *ngIf="question.question.multiselect" class="badge badge-success formViewSummaryLabel">
            Select Multiple
        </span>
        <span *ngIf="question.question?.datatypeText?.minLength" class="badge badge-success formViewSummaryLabel">
            At least: {{question.question?.datatypeText?.minLength}} characters
        </span>
        <span *ngIf="question.question?.datatypeText?.maxLength" class="badge badge-success formViewSummaryLabel">
            At most: {{question.question?.datatypeText?.maxLength}} characters
        </span>
        <span *ngIf="question.question?.datatypeNumber?.minValue" class="badge badge-success formViewSummaryLabel">
            At least: {{question.question?.datatypeNumber.minValue}}
        </span>
        <span *ngIf="question.question?.datatypeNumber?.maxValue" class="badge badge-success formViewSummaryLabel">
            At most: {{question.question?.datatypeNumber?.maxValue}}
        </span>
        <span *ngIf="question.question?.datatypeDate?.format" class="badge badge-success formViewSummaryLabel">
            Format: {{question.question?.datatypeDate?.format}}
        </span>
        <span *ngIf="getRepeatLabel(question)" class="badge badge-primary formViewSummaryLabel">
            Repeats: {{getRepeatLabel(question)}} times
        </span>
        <span *ngIf="isScore(question)" class="badge badge-primary formViewSummaryLabel">
            Score: <span [textContent]="question.question.scoreFormula"></span>
        </span>
        <span *ngIf="question.question.required" class="badge badge-danger formViewSummaryLabel">
            Required
        </span>
        <span *ngIf="question.question.invisible" class="badge badge-secondary formViewSummaryLabel"
              style="background-color: #666">
            Invisible
        </span>
        <span *ngIf="question.question.editable === false" class="badge badge-secondary formViewSummaryLabel"
              style="background-color: #666">
            Disabled
        </span>
        <span *ngIf="question.skipLogic?.condition?.length > 0 && parent"
              class="badge badge-warning formViewSummaryLabel">
            Show if: {{question.skipLogic.condition}}
        </span>
    </div>
    <div class="row">
        <div class="col-12">
            <div *ngIf="question.instructions?.value" class="questionInstruction">
                <span class="formViewQuestionLabel">Instructions:</span>
                <span *ngIf="question.instructions.valueFormat === 'html'"
                      [innerHtml]="question.instructions.value"></span>
                <span *ngIf="question.instructions.valueFormat !== 'html'"
                      [textContent]="question.instructions.value"></span>
            </div>
            <div class="answerList"
                 *ngIf="question.question.datatype === 'Value List' && question.question.answers && question.question.answers.length > 0">
                <span class="formViewQuestionLabel">Answer Choices:</span>
                <span *ngFor="let pv of question.question.answers" class="badge badge-secondary formViewSummaryLabel"
                      style="background-color: #666" [textContent]="pv?.valueMeaningName"></span>
            </div>
            <div *ngIf="question.question.datatype === 'Date' && question.question.datatypeDate.precision !== 'Day'"
                 class="defaultAnswer">
                <span class="formViewQuestionLabel">Precision:</span>
                <span class="badge badge-secondary formViewSummaryLabel"
                      style="background-color: #666">{{question.question.datatypeDate.precision}}</span>
            </div>
            <div *ngIf="question.question.defaultAnswer"
                 class="defaultAnswer">
                <span class="formViewQuestionLabel">Default Answer:</span>
                <span class="badge badge-secondary formViewSummaryLabel" style="background-color: #666">{{question.question.defaultAnswer}}</span>
            </div>
            <div *ngIf="question.question.unitsOfMeasure.length > 0" class="questionUom">
                <span class="formViewQuestionLabel">Units of Measure:</span>
                <span *ngFor="let u of question.question.unitsOfMeasure; let index = index"
                      class="badge badge-info formViewSummaryLabel"
                      [ngClass]="{'badge-danger': (question.question.uomsValid && question.question.uomsValid[index])}">
                    <ng-container *ngIf="u.system">{{u.system}}/</ng-container>{{u.code}}<ng-container
                        *ngIf="question.question.uomsValid && question.question.uomsValid[index]">&nbsp;(Error: {{question.question.uomsValid[index]}})</ng-container>
                </span>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #formDescriptionQuestionEditTmpl>
    <dl class="row">
        <dt class="col-2">Label:</dt>
        <dd class="col-10">
            <i class="fa fa-pencil changeQuestionLabelIcon hand-cursor" title="Change question label"
               (click)="openNameSelect(question, parent)"></i>
            <span *ngIf="!question.hideLabel">{{question.label}}</span>
            <span *ngIf="question.hideLabel">(No label)</span>
        </dd>
        <dt class="col-2">Instructions:</dt>
        <dd class="col-10 editQuestionInstruction">
            <cde-inline-area-edit
                    [(model)]="question.instructions.value"
                    [(defFormat)]="question.instructions.valueFormat"
                    [isAllowed]="true" (modelChange)="onEltChange.emit()">
            </cde-inline-area-edit>
        </dd>
        <ng-container *ngIf="question.question.datatype === 'Date'">
            <dt class="col-2 font-weight-bold">Date Precision:</dt>
            <dd class="col-10">
                <select [(ngModel)]="question.question.datatypeDate.precision" (change)="onEltChange.emit()"
                        class="form-control" style="width: fit-content">
                    <option>Year</option>
                    <option>Month</option>
                    <option>Day</option>
                    <option>Hour</option>
                    <option>Minute</option>
                    <option>Second</option>
                </select>

            </dd>
        </ng-container>
        <dt class="col-2">Required:</dt>
        <dd class="col-10">
            <input type="checkbox" title="Required" [(ngModel)]="question.question.required"
                   (change)="onEltChange.emit()"/>
        </dd>
        <dt class="col-2">Invisible:</dt>
        <dd class="col-10 editQuestionInvisible">
            <input type="checkbox" title="Invisible" [(ngModel)]="question.question.invisible"
                   (change)="onEltChange.emit()">
        </dd>
        <ng-container *ngIf="parent">
            <dt class="col-2">Show if:</dt>
            <dd class="col-10 skipLogicEditTextarea" [ngClass]="{'has-error':question.skipLogic?.validationError}">
                <input #slInput type="text" title="Show if"
                       (focus)="slOptionsRetrigger()"
                       [ngModel]="question.skipLogic.condition"
                       (ngModelChange)="typeaheadSkipLogic(parent, question, $event);"
                       class="form-control skipLogicCondition"
                       placeholder="Start typing a question name to find options"
                       [ngbTypeahead]="getSkipLogicOptions"
                       (selectItem)="typeaheadSkipLogic(parent, question, $event);$event.preventDefault();slInput.focus();slOptionsRetrigger()"/>
                <span style="color: red">{{question.skipLogic?.validationError}}</span>
            </dd>
        </ng-container>
        <ng-container *ngIf="question.question.datatype === 'Number' || question.question.datatype === 'Text'">
            <dt class="col-2">Units of Measure:</dt>
            <dd class="col-10 questionUom">
                <div class="border rounded p-1">
                    <span *ngFor="let u of question.question.unitsOfMeasure;let i = index;"
                          class="badge badge-info formViewSummaryLabel">
                        <i class="fa fa-times hand-cursor dark-icon pl-1"
                           (click)="removeUomByIndex(i);"></i>
                        <ng-container *ngIf="u.system">{{u.system}}/</ng-container>{{u.code}}
                    </span>
                    <ng-template #rt let-r="result" let-t="term">
                        <dl class="row" *ngIf="r.name">
                            <dt class="col-2">synonyms:</dt>
                            <dd class="col-10 mb-0">
                                <span *ngFor="let s of r.synonyms">{{s}} </span>
                            </dd>
                            <dt class="col-2">name:</dt>
                            <dd class="col-10 mb-0">{{ r.name}}</dd>
                            <dt class="col-2">code:</dt>
                            <dd class="col-10 mb-0">{{r.code}}</dd>
                        </dl>
                        <span *ngIf="!r.name">
                            <i class="fa fa-warning"> {{r.code}} is not a valid UCUM Unit</i>
                        </span>
                    </ng-template>
                    <div class="p-1">
                        Add
                        <select class="form-control d-inline-block" style="max-width: 100px"
                                [(ngModel)]="newUomSystem" title="New Unit of Measure System">
                            <option value="UCUM">UCUM</option>
                            <option value="">Other</option>
                        </select>
                        <ng-container *ngIf="newUomSystem === 'UCUM'; else manualUom">
                            <input class="form-control d-inline-block" style="max-width: 200px"
                                   [ngbTypeahead]="ucumService.search" title="New Unit of Measure Code"
                                   [resultTemplate]="rt" [(ngModel)]="newUom" [container]="'body'"
                                   (selectItem)="uomAddSelected($event);"/>
                        </ng-container>
                        <ng-template #manualUom>
                            <input class="form-control d-inline-block" style="max-width: 200px" [(ngModel)]="newUom"/>
                            <button class="btn btn-outline-dark" style="vertical-align: baseline"
                                    (click)="uomAddNew()"><i class="fa fa-plus"></i></button>
                        </ng-template>
                        <ng-container *ngFor="let e of question.question.uomsValid; index as i">
                            <div *ngIf="e" style="color: red">
                                <ng-container *ngIf="question.question.unitsOfMeasure[i].system">
                                    {{question.question.unitsOfMeasure[i].system}}/
                                </ng-container>
                                {{question.question.unitsOfMeasure[i].code}} - {{e}}
                            </div>
                        </ng-container>
                    </div>
                </div>
            </dd>
        </ng-container>
        <ng-container *ngIf="question.question.datatype === 'Value List'">
            <dt class="col-2">Multiple Selection:</dt>
            <dd class="col-10 multipleSelection">
                <input type="checkbox" title="Multiple" [(ngModel)]="question.question.multiselect"
                       (change)="onEltChange.emit()"/>
            </dd>
            <dt class="col-2 answerListLabel">Answer List
                <i *ngIf="question.question.answers.length > 0" class="fa fa-pencil hand-cursor"
                   (click)="openEditAnswerModal(question)"></i>:
            </dt>
            <dd class="col-10 answerList">
                <ng-select [(ngModel)]="question.question.answers" [items]="answerList$"
                           [multiple]="true" bindLabel="valueMeaningName" placeholder="Select Answer"
                           [appendTo]="'body'" [hideSelected]="true" (add)="onAnswerListAdd();"
                           (remove)="onAnswerListRemove($event);" (clear)="onEltChange.emit();">
                </ng-select>
            </dd>
        </ng-container>
        <dt class="col-2">Default Answer:</dt>
        <dd class="col-10 defaultAnswer">
            <ng-container *ngIf="question.question.datatype === 'Value List'">
                <ng-select [(ngModel)]="question.question.defaultAnswer" [items]="defaultAnswerList$"
                           bindLabel="valueMeaningName" bindValue="valueMeaningName" placeholder="Select Default Answer"
                           [appendTo]="'body'" [hideSelected]="true" (change)="onEltChange.emit()">
                </ng-select>
            </ng-container>
            <ng-container *ngIf="question.question.datatype !== 'Value List'">
                <cde-inline-edit [(model)]="question.question.defaultAnswer" [isAllowed]="true"
                                 (modelChange)="onEltChange.emit()"></cde-inline-edit>
            </ng-container>
        </dd>
        <ng-container *ngIf="question.question.defaultAnswer">
            <dt class="col-2">Editable:</dt>
            <dd class="col-10">
                <input type="checkbox" title="Editable" [(ngModel)]="question.question.editable"
                       (change)="onEltChange.emit()"/>
            </dd>
        </ng-container>
        <ng-container *ngIf="!question.question.cde.tinyId">
            <dt class="col-2">CDE Names:</dt>
            <dd class="col-10 cdeName">
                <table class="table table-border table-responsive">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Definition</th>
                        <th>Tags</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr *ngFor="let cdeNaming of question.question.cde.naming;let i = index;">
                        <td>
                            <cde-inline-edit [(model)]="cdeNaming.designation" [isAllowed]="true"
                                             (modelChange)="onEltChange.emit();"></cde-inline-edit>
                        </td>
                        <td>
                            <cde-inline-edit [(model)]="cdeNaming.definition" [isAllowed]="true"
                                             (modelChange)="onEltChange.emit();"></cde-inline-edit>
                        </td>
                        <td>
                            <ng-select [(ngModel)]="cdeNaming.tags" [items]="tag$" [hideSelected]="true"
                                       multiple="true" bindLabel="name" [appendTo]="'body'" [hideSelected]="true"
                                       (change)="onEltChange.emit();">
                            </ng-select>
                        </td>
                        <td>
                            <i class="fa fa-trash hand-cursor" (click)="removeCdeNaming(i);"></i>
                        </td>
                    </tr>
                    <tr class="newCdeName">
                        <td><input [(ngModel)]="newCdeNaming.designation" class="w-100 newCdeDesignation"/></td>
                        <td><input [(ngModel)]="newCdeNaming.definition" class="w-100 newCdeDefinition"/></td>
                        <td class="newCdeTags">
                            <ng-select [(ngModel)]="newCdeNaming.tags" [items]="tag$" [hideSelected]="true"
                                       multiple="true" bindLabel="name" bindValue="name" [appendTo]="'body'"
                                       [hideSelected]="true">
                            </ng-select>
                        </td>
                        <td>
                            <i class="fa fa-plus hand-cursor" (click)="addNewCdeNaming(newCdeNaming);"></i>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </dd>
            <dt class="col-2">CDE Identifiers:</dt>
            <dd class="col-10 cdeIdentifier">
                <table class="table table-border table-responsive">
                    <thead>
                    <tr>
                        <th>Source</th>
                        <th>ID</th>
                        <th>Version</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr *ngFor="let cdeId of question.question.cde.ids;let i = index;">
                        <td>
                            <cde-inline-edit [(model)]="cdeId.source" [isAllowed]="true"
                                             (modelChange)="onEltChange.emit();"></cde-inline-edit>
                        </td>
                        <td>
                            <cde-inline-edit [(model)]="cdeId.id" [isAllowed]="true"
                                             (modelChange)="onEltChange.emit();"></cde-inline-edit>
                        </td>
                        <td>
                            <cde-inline-edit [(model)]="cdeId.version" [isAllowed]="true"
                                             (modelChange)="onEltChange.emit();"></cde-inline-edit>
                        </td>
                        <td>
                            <i class="fa fa-trash hand-cursor" (click)="removeCdeId(i);"></i>
                        </td>
                    </tr>
                    <tr class="newCdeIdentifier">
                        <td><input [(ngModel)]="newCdeId.source" class="w-100 newCdeSource"/></td>
                        <td><input [(ngModel)]="newCdeId.id" class="w-100 newCdeId"/></td>
                        <td><input [(ngModel)]="newCdeId.version" class="w-100 newCdeVersion"/></td>
                        <td><i class="fa fa-plus hand-cursor" (click)="addNewCdeId(newCdeId);"></i></td>
                    </tr>
                    </tbody>
                </table>
            </dd>
            <dt class="col-2">CDE Datatype:</dt>
            <dd class="col-10 cdeDataType">
                <ng-select [(ngModel)]="question.question.cde.datatype"
                           [items]="dataType$" bindValue="value"
                           placeholder="Select data type" [appendTo]="'body'" [hideSelected]="true"
                           (change)="onEltChange.emit()">
                </ng-select>
            </dd>
            <ng-container *ngIf="question.question.cde.datatype==='Value List'">
                <dt class="col-2">CDE Permissible Values:</dt>
                <dd class="col-10 cdePVs">
                    <table class="table table-border table-responsive">
                        <thead>
                        <tr>
                            <th>Value</th>
                            <th>Code Name</th>
                            <th>Code</th>
                            <th>Code System</th>
                            <th>Code Description</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let cdePv of question.question.cde.permissibleValues;let i = index;">
                            <td>
                                <cde-inline-edit [(model)]="cdePv.permissibleValue" [isAllowed]="true"
                                                 (modelChange)="onEltChange.emit();"></cde-inline-edit>
                            </td>
                            <td>
                                <cde-inline-edit [(model)]="cdePv.valueMeaningName" [isAllowed]="true"
                                                 (modelChange)="onEltChange.emit();"></cde-inline-edit>
                            <td>
                                <cde-inline-edit [(model)]="cdePv.valueMeaningCode" [isAllowed]="true"
                                                 (modelChange)="onEltChange.emit();"></cde-inline-edit>
                            </td>
                            <td>
                                <cde-inline-edit [(model)]="cdePv.codeSystemName" [isAllowed]="true"
                                                 (modelChange)="onEltChange.emit();"></cde-inline-edit>
                            </td>
                            <td>
                                <cde-inline-edit [(model)]="cdePv.valueMeaningDefinition" [isAllowed]="true"
                                                 (modelChange)="onEltChange.emit();"></cde-inline-edit>
                            </td>
                            <td>
                                <i class="fa fa-trash hand-cursor" (click)="removeCdePv(i);"></i>
                            </td>
                        </tr>
                        <tr class="newCdePv">
                            <td><input [(ngModel)]="newCdePv.permissibleValue" class="w-100 permissibleValue"/></td>
                            <td><input [(ngModel)]="newCdePv.valueMeaningName" class="w-100 pvName"/></td>
                            <td><input [(ngModel)]="newCdePv.valueMeaningCode" class="w-100 pvCode"/></td>
                            <td><input [(ngModel)]="newCdePv.codeSystemName" class="w-100 pvCodeSystem"/></td>
                            <td><input [(ngModel)]="newCdePv.valueMeaningDefinition" class="w-100 pvDefinition"/></td>
                            <td>
                                <i class="fa fa-plus hand-cursor" (click)="addNewCdePv(newCdePv);"></i>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </dd>
            </ng-container>
        </ng-container>
    </dl>
</ng-template>

<ng-template #formDescriptionNameSelectTmpl let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h3>Select a question label from a CDE Name</h3>
    </div>

    <div class="modal-body">
        <div *ngIf="nameSelectModal.cde === null"><i class="fa fa-spinner fa-pulse"></i> Loading...</div>
        <div *ngIf="nameSelectModal.cde === 'error'">There is an issue retrieving this Data Element.</div>
        <ngb-alert *ngIf="nameSelectModal.updateSkipLogic">
            There is skip logic using this label. It will be updated.
        </ngb-alert>

        <div *ngFor="let naming of nameSelectModal.cde.naming; let i = index" class="row" id="q_select_name_{{i}}">
            <div class="col-3">
                <button class="btn btn-outline-dark" (click)="nameSelectModal.okSelect(naming)">
                    <i class="fa fa-check mr-1"></i>Select
                </button>
            </div>
            <div class="col-9">
                <dl class="row">
                    <dt class="col-2">Name:</dt>
                    <dd class="col-10">
                        <cde-inline-edit [(model)]="naming.designation"
                                         (modelChange)="onEltChange.emit();"></cde-inline-edit>
                    </dd>
                    <dt class="col-2">Definition:</dt>
                    <dd class="col-10">
                        <cde-inline-area-edit [(model)]="naming.definition" (modelChange)="onEltChange.emit();"
                                              [(defFormat)]="naming.definitionFormat"></cde-inline-area-edit>
                    </dd>
                    <dt class="col-2"> Tags:</dt>
                    <dd class="col-10">
                        <ng-select [(ngModel)]="naming.tags" [items]="tag$" [hideSelected]="true"
                                   multiple="true" bindLabel="name" [appendTo]="'body'" [hideSelected]="true"
                                   (change)="onEltChange.emit();">
                        </ng-select>
                    </dd>
                </dl>
            </div>
            <hr/>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <button class="btn btn-outline-dark" (click)="nameSelectModal.okSelect()">
                    <i class="fa fa-stop"></i> No Label
                </button>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-warning" (click)="d()" id="cancelSelect">Cancel</button>
    </div>
</ng-template>