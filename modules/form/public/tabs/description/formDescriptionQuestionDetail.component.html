<ng-template [ngTemplateOutlet]="getTemplate()" [ngOutletContext]="{ $implicit: question }"></ng-template>

<ng-template #formDescriptionQuestionTmpl>
    <div class="my-1">
        <span *ngIf="question.question.multiselect" class="badge badge-success formViewSummaryLabel">
            Select Multiple
        </span>
        <span *ngIf="question.question?.datatypeText?.minLength" class="badge badge-success formViewSummaryLabel">
            At least: {{question.question?.datatypeText?.minLength}} characters
        </span>
        <span *ngIf="question.question?.datatypeText?.maxLength" class="badge badge-success formViewSummaryLabel">
            At most: {{question.question?.datatypeText?.maxLength}} characters
        </span>
        <span *ngIf="question.question?.datatypeNumber?.minValue" class="badge badge-success formViewSummaryLabel">
            At least: {{question.question?.datatypeNumber.minValue}}
        </span>
        <span *ngIf="question.question?.datatypeNumber?.maxValue" class="badge badge-success formViewSummaryLabel">
            At most: {{question.question?.datatypeNumber?.maxValue}}
        </span>
        <span *ngIf="question.question?.datatypeDate?.format" class="badge badge-success formViewSummaryLabel">
            Format: {{question.question?.datatypeDate?.format}}
        </span>
        <span *ngIf="getRepeatLabel(question)" class="badge badge-primary formViewSummaryLabel">
            Repeats: {{getRepeatLabel(question)}} times
        </span>
        <span *ngIf="isScore(question)" class="badge badge-primary formViewSummaryLabel">
            Score: <span [textContent]="question.question.scoreFormula"></span>
        </span>
        <span *ngIf="question.question.required" class="badge badge-danger formViewSummaryLabel">
            Required
        </span>
        <span *ngIf="question.question.invisible" class="badge badge-secondary formViewSummaryLabel"
              style="background-color: #666">
            Invisible
        </span>
        <span *ngIf="question.question.editable === false" class="badge badge-secondary formViewSummaryLabel"
              style="background-color: #666">
            Disabled
        </span>
        <span *ngIf="question.skipLogic?.condition?.length > 0 && parent"
              class="badge badge-warning formViewSummaryLabel">
            Show if: {{question.skipLogic.condition}}
        </span>
    </div>
    <div class="row">
        <div class="col-12">
            <div *ngIf="question.instructions?.value" class="questionInstruction">
                <span class="formViewQuestionLabel">Instructions:</span>
                <span *ngIf="question.instructions.valueFormat === 'html'"
                      [innerHtml]="question.instructions.value"></span>
                <span *ngIf="question.instructions.valueFormat !== 'html'"
                      [textContent]="question.instructions.value"></span>
            </div>
            <div class="answerList" *ngIf="question.question.answers && question.question.answers.length > 0">
                <span class="formViewQuestionLabel">Answer Choices:</span>
                <span *ngFor="let pv of question.question.answers"
                      class="badge badge-secondary m-1 formViewSummaryLabel"
                      style="background-color: #666" [textContent]="pv?.valueMeaningName"></span>
            </div>
            <div *ngIf="question.question.defaultAnswer && question.question.defaultAnswer.length > 0"
                 class="defaultAnswer">
                <span class="formViewQuestionLabel">Default Answer:</span>
                <span class="badge badge-secondary mx-1 formViewSummaryLabel" style="background-color: #666">{{question.question.defaultAnswer}}</span>
            </div>
            <div *ngIf="question.question.uoms.length > 0" class="questionUom">
                <span class="formViewQuestionLabel">Units of Measure:</span>
                <span *ngFor="let uom of question.question.uoms; let index = index"
                      class="badge badge-info m-1 formViewSummaryLabel"
                      [ngClass]="{'badge-danger': (question.question.uomsValid && !question.question.uomsValid[index])}">
                    <span [textContent]="uom"></span>
                    <span *ngIf="question.question.uomsValid && !question.question.uomsValid[index]">&nbsp;(invalid)</span>
                </span>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #formDescriptionQuestionEditTmpl>
    <dl class="row">
        <dt class="col-2">Label:</dt>
        <dd class="col-10">
            <i class="fa fa-pencil changeQuestionLabelIcon" title="Change question label"
               (click)="openNameSelect(question, parent)"></i>
            <span *ngIf="!question.hideLabel">{{question.label}}</span>
            <span *ngIf="question.hideLabel">(No label)</span>
        </dd>
        <dt class="col-2">Instructions:</dt>
        <dd class="col-10 editQuestionInstruction">
            <cde-inline-area-edit
                    [(model)]="question.instructions.value"
                    [(defFormat)]="question.instructions.valueFormat"
                    [isAllowed]="true" (modelChange)="onEltChange.emit()">
            </cde-inline-area-edit>
        </dd>
        <dt class="col-2">Required:</dt>
        <dd class="col-10">
            <input type="checkbox" title="Required" [(ngModel)]="question.question.required"
                   (change)="onEltChange.emit()"/>
        </dd>
        <dt class="col-2">Invisible:</dt>
        <dd class="col-10 editQuestionInvisible">
            <input type="checkbox" title="Invisible" [(ngModel)]="question.question.invisible"
                   (change)="onEltChange.emit()">
        </dd>
        <ng-container *ngIf="parent">
            <dt class="col-2">Show if:</dt>
            <dd class="col-10 skipLogicEditTextarea" [ngClass]="{'has-error':question.skipLogic?.validationError}">
                <input #slInput type="text" title="Show if"
                       (focus)="slOptionsRetrigger()"
                       [ngModel]="question.skipLogic.condition"
                       (ngModelChange)="typeaheadSkipLogic(parent, question, $event);"
                       class="form-control skipLogicCondition"
                       placeholder="Start typing a question name to find options"
                       [ngbTypeahead]="getSkipLogicOptions"
                       (selectItem)="typeaheadSkipLogic(parent, question, $event);$event.preventDefault();slInput.focus();slOptionsRetrigger()"/>
                <span [textContent]="question.skipLogic?.validationError"></span>
            </dd>
        </ng-container>
        <dt class="col-2">Units of Measure:</dt>
        <dd class="col-10 questionUom">
            <ng-container *ngFor="let q of [uomVersion]">
                <select2 class="formDescriptionUoms" [data]="getUoms()" [value]="question.question.uoms"
                         [options]="uomOptions" width="100%"
                         (valueChanged)="checkUom($event)">
                </select2>
            </ng-container>
        </dd>
        <dt class="col-2">Datatype:</dt>
        <dd class="col-10">{{question.question.datatype | cdePlaceholder }}</dd>
        <ng-container *ngIf="question.question.datatype === 'Text'">
            <dt class="col-2">Min Length:</dt>
            <dd class="col-10"> {{question.question?.datatypeText?.minLength | cdePlaceholder }}</dd>
            <dt class="col-2">Max Length:</dt>
            <dd class="col-10"> {{question.question?.datatypeText?.maxLength | cdePlaceholder}}</dd>
        </ng-container>
        <ng-container *ngIf="question.question.datatype === 'Number'">
            <dt class="col-2">Min Value:</dt>
            <dd class="col-10"> {{question.question?.datatypeNumber?.minValue | cdePlaceholder }}</dd>
            <dt class="col-2">Max Value:</dt>
            <dd class="col-10"> {{question.question?.datatypeNumber?.maxValue | cdePlaceholder }}</dd>
        </ng-container>
        <ng-container *ngIf="question.question.datatype === 'Date'">
            <dt class="col-2">Date Format:</dt>
            <dd class="col-10"> {{question.question?.datatypeDate?.format}}</dd>
        </ng-container>
        <ng-container *ngIf="question.question.datatype === 'Value List'">
            <dt class="col-2">Multiple Selection:</dt>
            <dd class="col-10 multipleSelection">
                <input type="checkbox" title="Multiple" [(ngModel)]="question.question.multiselect"
                       (change)="onEltChange.emit()"/>
            </dd>
            <dt class="col-2">Answer List:</dt>
            <dd class="col-10">
                <select2 class="formDescriptionAnswerList" [data]="getAnswersData()" [value]="getAnswersValue()"
                         [options]="answersOptions" width="100%"
                         (valueChanged)="checkAnswers($event)">
                </select2>
            </dd>
        </ng-container>
        <dt class="col-2">Default Answer:</dt>
        <dd class="col-10 defaultAnswer">
            <ng-container *ngIf="question.question.datatype === 'Value List'">
                <select title="Default" class="form-control"
                        [(ngModel)]="question.question.defaultAnswer" (change)="onEltChange.emit()">
                    <option value=""></option>
                    <option *ngFor="let pv of question.question.answers " [value]="pv.permissibleValue"
                            [textContent]="pv?.valueMeaningName"></option>
                </select>
            </ng-container>
            <ng-container *ngIf="question.question.datatype !== 'Value List'">
                <cde-inline-edit [(model)]="question.question.defaultAnswer" [isAllowed]="true"
                                 (modelChange)="onEltChange.emit()"></cde-inline-edit>
            </ng-container>
        </dd>
        <ng-container *ngIf="question.question.defaultAnswer">
            <dt class="col-2">Editable:</dt>
            <dd class="col-10">
                <input type="checkbox" title="Editable" [(ngModel)]="question.question.editable"
                       (change)="onEltChange.emit()"/>
            </dd>
        </ng-container>
        <ng-container *ngIf="!question.question.cde.tinyId">
            <dt class="col-2">CDE Namings:</dt>
            <dd class="col-10">
                <table class="table table-border table-responsive">
                    <tr>
                        <th>Name</th>
                        <th>Definition</th>
                        <th>Tags</th>
                        <th></th>
                    </tr>
                    <tr *ngFor="let cdeNaming of question.question.cde.naming;let i = index;">
                        <td>
                            <cde-inline-edit [(model)]="cdeNaming.designation" [isAllowed]="true"
                                             (modelChange)="onEltChange.emit();"></cde-inline-edit>
                        </td>
                        <td>
                            <cde-inline-edit [(model)]="cdeNaming.definition" [isAllowed]="true"
                                             (modelChange)="onEltChange.emit();"></cde-inline-edit>
                        <td>
                        <select2 [data]="[]" [value]="cdeNaming.tags" [options]="options"
                                 [disabled]="false" width="100%"
                                 (valueChanged)="changedTags(name,$event)">
                        </select2>
                        </td>
                        <td>
                            <button class="btn btn-outline-danger btn-xs" (click)="removeCdeNaming(i);">Remove</button>
                        </td>
                    </tr>
                    <tr>
                        <td><input [(ngModel)]="newCdeNaming.designation" class="w-100"/></td>
                        <td><input [(ngModel)]="newCdeNaming.definition" class="w-100"/></td>
                        <td><input [(ngModel)]="newCdeNaming.tags" class="w-100"/></td>
                        <td>
                            <button class="btn btn-outline-success btn-xs" (click)="addNewCdeNaming(newCdeNaming);">
                                Add
                            </button>
                        </td>
                    </tr>
                </table>

            </dd>
            <dt class="col-2">CDE Identifiers:</dt>
            <dd class="col-10">
                <table class="table table-border table-responsive">
                    <tr>
                        <th>Source</th>
                        <th>ID</th>
                        <th>Version</th>
                        <th></th>
                    </tr>
                    <tr *ngFor="let cdeId of question.question.cde.ids;let i = index;">
                        <td>
                            <cde-inline-edit [(model)]="cdeId.source" [isAllowed]="true"
                                             (modelChange)="onEltChange.emit();"></cde-inline-edit>
                        </td>
                        <td>
                            <cde-inline-edit [(model)]="cdeId.id" [isAllowed]="true"
                                             (modelChange)="onEltChange.emit();"></cde-inline-edit>
                        <td>
                            <cde-inline-edit [(model)]="cdeId.version" [isAllowed]="true"
                                             (modelChange)="onEltChange.emit();"></cde-inline-edit>
                        </td>
                        <td>
                            <button class="btn btn-outline-danger btn-xs" (click)="removeCdeId(i);">Remove</button>
                        </td>
                    </tr>
                    <tr>
                        <td><input [(ngModel)]="newCdeId.source" class="w-100"/></td>
                        <td><input [(ngModel)]="newCdeId.id" class="w-100"/></td>
                        <td><input [(ngModel)]="newCdeId.version" class="w-100"/></td>
                        <td>
                            <button class="btn btn-outline-success btn-xs" (click)="addNewCdeId(newCdeId);">Add</button>
                        </td>
                    </tr>
                </table>

            </dd>
            <dt class="col-2">CDE Datatype:</dt>
            <dd class="col-10">
                <select2 [data]="dataTypeOptions" [value]="question.question.cde.datatype"
                         [options]="datatypeSelect2Options"
                         width="100%" (valueChanged)="changedDatatype($event)">
                </select2>
            </dd>
            <ng-container *ngIf="question.question.cde.datatype==='Value List'">
                <dt class="col-2">CDE Permissible Values:</dt>
                <dd class="col-10">
                    <table class="table table-border table-responsive">
                        <tr>
                            <th>Value</th>
                            <th>Code Name</th>
                            <th>Code</th>
                            <th>Code System</th>
                            <th>Code Description</th>
                            <th></th>
                        </tr>
                        <tr *ngFor="let cdePv of question.question.cde.permissibleValues;let i = index;">
                            <td>
                                <cde-inline-edit [(model)]="cdePv.permissibleValue" [isAllowed]="true"
                                                 (modelChange)="onEltChange.emit();"></cde-inline-edit>
                            </td>
                            <td>
                                <cde-inline-edit [(model)]="cdePv.valueMeaningName" [isAllowed]="true"
                                                 (modelChange)="onEltChange.emit();"></cde-inline-edit>
                            <td>
                                <cde-inline-edit [(model)]="cdePv.valueMeaningCode" [isAllowed]="true"
                                                 (modelChange)="onEltChange.emit();"></cde-inline-edit>
                            </td>
                            <td>
                                <cde-inline-edit [(model)]="cdePv.codeSystemName" [isAllowed]="true"
                                                 (modelChange)="onEltChange.emit();"></cde-inline-edit>
                            </td>
                            <td>
                                <cde-inline-edit [(model)]="cdePv.valueMeaningDefinition" [isAllowed]="true"
                                                 (modelChange)="onEltChange.emit();"></cde-inline-edit>
                            </td>
                            <td>
                                <button class="btn btn-outline-danger btn-xs" (click)="removeCdePv(i);">Remove</button>
                            </td>
                        </tr>
                        <tr>
                            <td><input [(ngModel)]="newCdePv.permissibleValue" class="w-100"/></td>
                            <td><input [(ngModel)]="newCdePv.valueMeaningName" class="w-100"/></td>
                            <td><input [(ngModel)]="newCdePv.valueMeaningCode" class="w-100"/></td>
                            <td><input [(ngModel)]="newCdePv.codeSystemName" class="w-100"/></td>
                            <td><input [(ngModel)]="newCdePv.valueMeaningDefinition" class="w-100"/></td>
                            <td>
                                <button class="btn btn-outline-success btn-xs" (click)="addNewCdePv(newCdePv);">Add
                                </button>
                            </td>
                        </tr>
                    </table>
                </dd>
            </ng-container>
        </ng-container>
    </dl>
    <button *ngIf="question.edit" class="btn btn-outline-success btn-sm" (click)="question.edit = false;">OK
    </button>
</ng-template>

<ng-template #formDescriptionNameSelectTmpl let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h3>Select a question label from a CDE Name</h3>
    </div>

    <div class="modal-body">
        <div *ngIf="nameSelectModal.cde === null"><i class="fa fa-spinner fa-pulse"></i> Loading...</div>
        <div *ngIf="nameSelectModal.cde === 'error'">There is an issue retrieving this Data Element.</div>
        <ngb-alert *ngIf="nameSelectModal.updateSkipLogic">
            There is skip logic using this label. It will be updated.
        </ngb-alert>

        <div *ngFor="let naming of nameSelectModal.cde.naming; let i = index" class="row" id="q_select_name_{{i}}">
            <div class="col-3">
                <button class="btn btn-outline-dark" (click)="nameSelectModal.okSelect(naming)">
                    <i class="fa fa-check mr-1"></i>Select
                </button>
            </div>
            <div class="col-9">
                <dl class="row">
                    <dt class="col-2">Name:</dt>
                    <dd class="col-10">
                        <cde-inline-edit [(model)]="naming.designation" (modelChange)="onEltChange.emit();"
                                         [isAllowed]="!question.question.cde.tinyId"></cde-inline-edit>
                    </dd>
                    <dt class="col-2">Definition:</dt>
                    <dd class="col-10">
                        <cde-inline-area-edit [(model)]="naming.definition" (modelChange)="onEltChange.emit();"
                                              [(defFormat)]="naming.definitionFormat"
                                              [isAllowed]="!question.question.cde.tinyId"></cde-inline-area-edit>
                    </dd>
                    <dt class="col-2"> Tags:</dt>
                    <dd class="col-10">
                        <select2 [data]="namingTags" [value]="naming.tags" [options]="namingSelet2Options" width="100%"
                                 [disabled]="question.question.cde.tinyId" (valueChanged)="changedTags(naming,$event)">
                        </select2>
                    </dd>
                </dl>
            </div>
            <hr/>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <button class="btn btn-outline-dark" (click)="nameSelectModal.okSelect()">
                    <i class="fa fa-stop"></i> No Label
                </button>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn  btn-warning" (click)="d()" id="cancelSelect">Cancel</button>
    </div>
</ng-template>
