<ng-container *ngIf="view === 'welcome'; then welcomeSearch else searchResults"></ng-container>

<ng-template #welcomeSearch>
    <div class="container">
        <div *ngIf="!addMode" class="jumbotron text-center d-none d-lg-block" style="background-color: #fff">
            <img [hidden]="embedded" id="homeNihCdeLogo" class="img-center-responsive"
                 alt="NIH Common Data Elements (CDE) log" src="/cde/public/assets/img/min/NIH-CDE.png"/>
        </div>
        <div class="row justify-content-md-center" id="searchDiv">
            <div class="col-12 col-md-10 mx-auto">
                <form #quickSearchForm="ngForm" id="quickSearchForm" novalidate style="max-width: 1000px">
                    <mat-form-field style="width: 100%; font-size: 25px">
                        <input matInput name="q" id="ftsearch-input" [placeholder]="'Search ' + (module === 'cde' ? 'Data Elements' : 'Forms')"
                               maxlength="500" [matAutocomplete]="auto"
                               [(ngModel)]="searchSettings.q" (ngModelChange)="searchTermAutoComplete.emit($event)">
                        <mat-icon matSuffix (click)="termSearch(true)" id="search.submit">search</mat-icon>
                    </mat-form-field>
                    <button style="display: none" type="submit" (click)="termSearch(true)"></button>

                    <mat-autocomplete #auto="matAutocomplete" (optionSelected)="typeaheadSelect($event)">
                        <mat-option *ngFor="let option of autocompleteSuggestions" [value]="option">
                            {{ option }}
                        </mat-option>
                    </mat-autocomplete>

                    <!-- Error display area -->
                    <p [hidden]="quickSearchForm.form.valid || quickSearchForm.form.pristine"
                       class="error-block">
                        <span>Query terms must be 500 characters or less.</span>
                    </p>
                </form>
            </div>
        </div>
        <div class="mt-3" id="tabs">
            <mat-tab-group>
                <mat-tab label="Browse by Classification" style="overflow: hidden">
                    <div *ngIf="orgs?.length === 0">
                        <h1 class="pl130">
                            <mat-icon class="spin">auto_renew</mat-icon>
                            Searching...
                        </h1>
                    </div>
                    <div class="row">
                        <div class="col-xl-3 col-lg-4 col-sm-6 col-12" *ngFor="let org of orgs"
                             id="search_by_classification_{{org.name}}">
                            <fieldset class="cdeFieldset welcomeSearchFieldset hand-cursor"
                                      (click)="browseOrg(org.name)">
                                <legend>
                                    <span id="browseOrg-{{org.name}}" class="browseLink">{{org.name}}</span>
                                </legend>
                                <div *ngIf="org.longName">{{org.longName}}</div>
                                <div class="welcomeCount"><span id="nbOfElts-{{org.name}}">{{org.count}}</span>
                                    elements
                                </div>
                                <div *ngIf="org.extraInfo">{{org.extraInfo}}</div>
                                <div *ngIf="org.uri"><a href="{{org.uri}}" target="_blank" rel="noopener noreferrer">Source</a>
                                </div>
                            </fieldset>
                            <mat-icon class="welcomeDetailIcon hand-cursor" *ngIf="org.htmlOverview"
                                      id="search_by_classification_info_{{org.name}}" (click)="openOrgDetails(org)">
                                help_outline
                            </mat-icon>
                        </div>
                    </div>
                </mat-tab>
                <mat-tab *ngIf="topics?.Diseases" label="Browse by Topic" id="browseByTopic">
                    <div class="row">
                        <div class="col-4" *ngFor="let key of topicsKeys; let i = index;">
                            <hr *ngIf="i > 2">
                            <h4>{{key}}</h4>
                            <ul style="list-style-type: none">
                                <li *ngFor="let t of topics[key]">
                                    <span class="fake-link" (click)="browseTopic(key + ';' + t.name)">
                                        {{t.name}} ({{t.count}})</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </mat-tab>
                <mat-tab disabled>
                    <ng-template mat-tab-label>
                        <cde-search-export-button id="exportEverything" *ngIf="!embedded"
                                                  (exportType)="exportService.exportSearchResults($event, module, {searchSettings: searchSettings})"
                                                  [module]="module">
                        </cde-search-export-button>
                    </ng-template>
                </mat-tab>
            </mat-tab-group>
        </div>
        <div class="mt-3">
            <span id="totalItems">{{totalItems}}</span><span> elements across all classifications</span>
        </div>
    </div>
</ng-template>

<ng-template #orgDetailsModal>
    <div style="margin: 25px" [innerHtml]="orgHtmlOverview"></div>
</ng-template>

<ng-template #searchResults>
    <nav *ngIf="elts && aggregations" class="navbar navbar-expand-lg navbar-light bg-light px-1" id="searchDiv">
        <form class="input-group">
            <button class="navbar-toggler navbar-toggler" type="button" data-toggle="collapse"
                    data-target="#searchBarContent" aria-controls="searchBarContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <mat-form-field style="width: 90%; padding-left: 30px; margin-bottom: -20px">
                <input matInput name="q" id="ftsearch-input" placeholder="Search"
                       #autoCompleteInput maxlength="500" [matAutocomplete]="auto"
                       [(ngModel)]="searchSettings.q" (ngModelChange)="searchTermAutoComplete.emit($event)">
                <mat-icon matSuffix (click)="termSearch()" id="search.submit">search</mat-icon>
            </mat-form-field>
            <button style="display: none" type="submit" (click)="termSearch()"></button>

            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="typeaheadSelect($event)">
                <mat-option *ngFor="let option of autocompleteSuggestions" [value]="option">
                    {{ option }}
                </mat-option>
            </mat-autocomplete>

        </form>
        <div class="ml-auto collapse navbar-collapse" style="width:auto;"
             id="searchBarContent" role="group" aria-label="Basic example">
            <button mat-raised-button *ngIf="embedded" id="resetSearch" class="mr-1" name="resetSearch"
                    type="button" (click)="reset()">
                <mat-icon>delete_outline</mat-icon>
                Reset
            </button>
            <button id="pinAll" (click)="openPinModal()" class="mx-1" mat-raised-button
                    [hidden]="totalItems <= 0 || module === 'form'" *ngIf="!embedded">
                <mat-icon svgIcon="thumb_tack"></mat-icon>
                Pin All
            </button>
            <button (click)="hideShowFilter()" class="mx-1" id="showHideFilters" mat-raised-button>
                <mat-icon>filter_list</mat-icon>
                <ng-container *ngIf="!filterMode"> Show Filters</ng-container>
                <ng-container *ngIf="filterMode"> Hide Filters</ng-container>
            </button>
            <cde-list-view-controls [(listView)]="resultsView" *ngIf="!embedded"></cde-list-view-controls>

            <button mat-raised-button [matMenuTriggerFor]="exportMenu" *ngIf="!embedded"
                    id="export" class="ml-1">
                <mat-icon>play_for_work</mat-icon>
                Export
                <mat-icon>arrow_drop_down</mat-icon>
            </button>

            <mat-menu #exportMenu>
                <ng-container *ngIf="userService.user || module === 'cde'; else exportFormNotAuthorized">
                    <a *ngFor="let key of ownKeys(exporters)" id="{{exporters[key].id}}" mat-menu-item
                       (click)="exportService.exportSearchResults(key, module, {searchSettings: searchSettings})"
                    >{{exporters[key].display}}</a>
                </ng-container>
                <ng-template #exportFormNotAuthorized>
                    <a routerLink="/login" mat-menu-item>Please login to export forms.</a>
                </ng-template>
                <a *ngIf="displayValidation()" id="exportValidRule" mat-menu-item
                   (click)="openValidRulesModal()"> Validation Rules</a>
            </mat-menu>
        </div>
    </nav>
    <div *ngIf="elts && aggregations" class="container-fluid ml-0">
        <div class="row">
            <div *ngIf="filterMode" [ngClass]="filterMode?'col-12 col-sm-2':'col-12'" class="px-1">
                <!--FILTERS-->
                <!-- CLASSIFICATION AGGREGATIONS -->
                <div *ngIf="aggregations.orgs.buckets" id="classificationListHolder" class="my-3">
                    <div>
                        <span class="treeTitle">Classification</span>
                        <mat-icon *ngIf="!altClassificationFilterMode && !embedded && !excludeOrgFilterMode"
                                  class="hand-cursor classification-filter" style="line-height: 12px"
                                  (click)="setAltClassificationFilterMode()"
                                  id="altClassificationFilterModeToggle" role="link"
                                  aria-label="Add a second classification filter as an AND condition"
                                  matTooltip="Add a second classification filter as an AND condition"
                                  matTooltipClass="cdeTooltip" matTooltipPosition="right">add_box
                        </mat-icon>
                        <mat-icon *ngIf="!excludeOrgFilterMode && !embedded && !altClassificationFilterMode"
                                  class="hand-cursor classification-filter" style="line-height: 12px"
                                  (click)="setExcludeOrgFilterMode()"
                                  id="excludeFilterModeToggle" role="link"
                                  aria-label="Add a second classification filter as a NOT condition"
                                  matTooltip="Add a second classification filter as a NOT condition"
                                  matTooltipClass="cdeTooltip" matTooltipPosition="right">indeterminate_check_box
                        </mat-icon>
                    </div>
                    <div *ngIf="excludeOrgFilterMode" class="treeChild hand-cursor" id="exludeAllOrgs"
                         (click)="searchExcludeAllOrgs()">
                        All (Except {{searchSettings.selectedOrg}})
                    </div>
                    <ng-container *ngFor="let t of aggregations.orgs.buckets; trackBy: trackByKey">
                        <ng-container *ngIf="getCurrentSelectedOrg(); else classifOrg">
                            <ng-container *ngIf="t.key === getCurrentSelectedOrg()">
                                <div *ngIf="getCurrentSelectedClassification()?.length; else classifSelf"
                                     id="classif-{{t.key}}" class="treeParent hand-cursor"
                                     [attr.aria-label]="t.longName" [matTooltip]="t.longName"
                                     matTooltipClass="cdeTooltip" matTooltipPosition="right"
                                     (click)="alterOrgFilter(t.key)" role="link">
                                    <mat-icon class="treeItemIcon">keyboard_arrow_left</mat-icon>
                                    <a class="treeItemText"> {{t.key}}</a>
                                </div>
                                <ng-template #classifSelf>
                                    <div id="classif-{{t.key}}" class="treeCurrent treeItemText"
                                         [attr.aria-label]="t.longName" [matTooltip]="t.longName"
                                         matTooltipClass="cdeTooltip" matTooltipPosition="right">{{t.key}}
                                    </div>
                                </ng-template>
                            </ng-container>
                        </ng-container>
                        <ng-template #classifOrg>
                            <div id="classif-{{t.key}}" class="treeChild hand-cursor" (click)="alterOrgFilter(t.key)"
                                 role="link" [attr.aria-label]="t.longName" [matTooltip]="t.longName"
                                 matTooltipClass="cdeTooltip" matTooltipPosition="right">
                                <mat-icon class="treeItemIcon">keyboard_arrow_right</mat-icon>
                                <a class="treeItemText">{{t.key}} (<span
                                        id="nbOfClassifElts-{{t.key}}">{{t.doc_count}}</span>)</a>
                            </div>
                        </ng-template>
                    </ng-container>
                    <ng-container *ngFor="let e of getCurrentSelectedClassification(); index as i; last as isLast">
                        <div *ngIf="!isLast; else classifSelf2" id="classif-{{e}}" class="treeParent hand-cursor"
                             (click)="selectElement(e)" role="link">
                            <mat-icon class="treeItemIcon">keyboard_arrow_left</mat-icon>
                            <a class="treeItemText"> {{e}}</a>
                        </div>
                        <ng-template #classifSelf2>
                            <div id="classif-{{e}}" class="treeCurrent treeItemText"
                                 [class.treeItem]="getCurrentSelectedClassification().length">{{e}}
                            </div>
                        </ng-template>
                    </ng-container>
                    <div *ngFor="let b of getClassificationSelectedOrg(); trackBy: trackByName"
                         id="classif-{{b.name}}" class="treeChild hand-cursor"
                         [class.treeItem]="getCurrentSelectedClassification().length"
                         (click)="selectElement(b.name)" role="link">
                        <mat-icon class="treeItemIcon">keyboard_arrow_right</mat-icon>
                        <a class="treeItemText">{{b.name}} (<span
                                id="nbOfClassifElts-{{b.name}}">{{b.count}}</span>)</a>
                    </div>
                </div>
                <!-- TOPIC AGGREGATIONS -->
                <div *ngIf="searchSettings.meshTree || aggregationsTopics.length" id="meshTreesListHolder"
                     class="my-3">
                    <span class="treeTitle">Topics</span>
                    <div *ngFor="let e of getCurrentSelectedTopic(); index as i; last as isLast"
                         id="topic-{{e}}" class="hand-cursor" (click)="selectTopic(e)" role="link">
                        <div *ngIf="!isLast; else topicSelf" class="treeParent">
                            <mat-icon class="treeItemIcon">keyboard_arrow_left</mat-icon>
                            <a class="treeItemText">{{e}}</a>
                        </div>
                        <ng-template #topicSelf>
                            <div class="treeCurrent treeItemText"
                                 [class.treeItem]="getCurrentSelectedTopic().length > 1">{{e}}
                            </div>
                        </ng-template>
                    </div>
                    <div *ngFor="let b of aggregationsTopics; trackBy: trackByName"
                         id="topic-{{b.name}}" class="treeChild hand-cursor"
                         [class.treeItem]="getCurrentSelectedTopic().length > 1"
                         (click)="selectTopic(b.name)" role="link">
                        <mat-icon class="treeItemIcon">keyboard_arrow_right</mat-icon>
                        <a class="treeItemText">{{b.name}} (<span
                                id="nbOfClassifElts-{{b.name}}">{{b.count}}</span>)</a>
                    </div>
                </div>
                <!-- REGISTRATION STATUS AGGREGATION -->
                <div *ngIf="aggregations.statuses.statuses.buckets" id="registrationStatusListHolder" class="my-3">
                    <span class="treeTitle">Registration Status</span>
                    <ng-container *ngFor="let t of aggregations.statuses.statuses.buckets">
                        <div *ngIf="t.doc_count > 0" id="regstatus-{{t.key}}" class="treeItem hand-cursor"
                             (click)="addStatusFilter(t.key)" role="link"
                             [attr.aria-label]="getRegStatusHelp(t.key)" [matTooltip]="getRegStatusHelp(t.key)"
                             matTooltipClass="cdeTooltip" matTooltipPosition="right">
                            <ng-container
                                    *ngIf="searchSettings.regStatuses && searchSettings.regStatuses.indexOf(t.key) > -1; else else06">
                                <mat-icon class="filter-cb">check_box</mat-icon>
                            </ng-container>
                            <ng-template #else06>
                                <mat-icon class="filter-cb">check_box_outline_blank</mat-icon>
                            </ng-template>
                            <a class="treeItemText">{{t.key}} ({{t.doc_count}})</a>
                        </div>
                    </ng-container>
                </div>
                <!--DATA TYPE AGGREGATION-->
                <div *ngIf="module === 'cde' && aggregations.datatype.datatype.buckets.length"
                     id="datatypeListHolder" class="my-3">
                    <span class="treeTitle">Data Types</span>
                    <ng-container *ngFor="let t of aggregations.datatype.datatype.buckets">
                        <div *ngIf="t.doc_count > 0" id="datatype-{{t.key}}" class="treeItem hand-cursor"
                             (click)="addDatatypeFilter(t.key)" role="link">
                            <ng-container
                                    *ngIf="searchSettings.datatypes && searchSettings.datatypes.indexOf(t.key) > -1; else else07">
                                <mat-icon class="filter-cb">check_box</mat-icon>
                            </ng-container>
                            <ng-template #else07>
                                <mat-icon class="filter-cb">check_box_outline_blank</mat-icon>
                            </ng-template>
                            <a class="treeItemText">{{t.key}} ({{t.doc_count}})</a>
                        </div>
                    </ng-container>
                </div>
            </div>
            <div class="px-1" [ngClass]="filterMode?'col-12 col-sm-10':'col-12'" [style.display]="searching ? 'none' : 'block'">
                <!-- BREADCRUMBS -->
                <div *ngIf="elts && aggregations" class="mx-1 my-3" id="searchResultInfoBar">
                    <strong id="searchResultNum">{{totalItems}}</strong>
                    <ng-container> {{module === 'cde' ? 'data element' : 'form'}} results for</ng-container>
                    <span *ngIf="searchedTerm" id="term_crumb" class="badge badge-light remove-filter hand-cursor dark-icon mx-1"
                          aria-label="Remove this search term filter" matTooltip="Remove this search term filter"
                          matTooltipClass="cdeTooltip" matTooltipPosition="right"
                          (click)="searchSettings.q = ''; doSearch()">
                        {{searchedTerm}}
                    </span>
                    <span *ngIf="hasSelectedClassifications()" id="classif_crumb"
                          class="badge badge-light remove-filter hand-cursor dark-icon mx-1"
                          aria-label="Remove this classification filter" matTooltip="Remove this classification filter"
                          matTooltipClass="cdeTooltip" matTooltipPosition="right"
                          (click)="clearSelectedClassifications()">
                        {{getSelectedClassifications()}}
                    </span>
                    <ng-container *ngIf="altClassificationFilterMode">
                        and
                        <span id="classifAlt_filter" class="badge badge-light remove-filter hand-cursor dark-icon pl-1"
                              aria-label="Remove this classification filter" matTooltip="Remove this classification filter"
                              matTooltipClass="cdeTooltip" matTooltipPosition="right"
                              (click)="clearSelectedClassificationsAlt()">
                            {{getSelectedClassificationsAlt()}}
                        </span>
                    </ng-container>
                    <ng-container *ngIf="excludeOrgFilterMode">
                        not
                        <span class="badge badge-light remove-filter hand-cursor dark-icon pl-1"
                              aria-label="Remove this classification filter" matTooltip="Remove this classification filter"
                              matTooltipClass="cdeTooltip" matTooltipPosition="right"
                              (click)="clearExcludeOrgs()">
                            {{getExcludedOrgs()}}
                        </span>
                    </ng-container>
                    <span *ngIf="hasSelectedTopics()" id="topic_crumb" class="badge badge-light remove-filter hand-cursor dark-icon mx-1"
                          aria-label="Remove this topics filter" matTooltip="Remove this topics filter"
                          matTooltipClass="cdeTooltip" matTooltipPosition="right"
                          (click)="clearSelectedTopics()">
                        {{getSelectedTopics()}}
                    </span>
                    <span *ngIf="hasSelectedStatuses()" id="status_crumb" class="badge badge-light remove-filter hand-cursor dark-icon mx-1"
                          aria-label="Remove this registration statuses filter"
                          matTooltip="Remove this registration statuses filter"
                          matTooltipClass="cdeTooltip" matTooltipPosition="right"
                          (click)="clearSelectedStatuses()">
                        {{getSelectedStatuses()}}
                    </span>
                    <span *ngIf="module === 'cde' && hasSelectedDatatypes()" id="datatype_crumb"
                          class="badge badge-light remove-filter hand-cursor dark-icon mx-1"
                          aria-label="Remove this datatype filter"
                          matTooltip="Remove this datatype filter"
                          matTooltipClass="cdeTooltip" matTooltipPosition="right"
                          (click)="clearSelectedDatatypes()">
                        {{getSelectedDatatypes()}}
                    </span>
                    <a (click)="reset()" class="a-link hand-cursor">Clear All</a>
                    <small> ({{took / 1000}} secs)</small>
                </div>
                <!-- SEARCH RESULTS -->
                <div id="resultList">
                    <div id="resultListTour"></div>
                    <span [hidden]="elts.length >= 0" class="h1 pl130">
                        <mat-icon class="spin">auto_renew</mat-icon>Searching...</span>
                    <span [hidden]="elts.length !== 0" class="h4"><mat-icon>sentiment_very_dissatisfied</mat-icon>
                        No results were found. Try other criterias or selecting more statuses</span>
                    <cde-list-view [elts]="elts" [embedded]="embedded" [module]="module" [(listView)]="resultsView"
                                   (add)="add.emit($event)"></cde-list-view>
                    <div>
                        <div class="float-right">
                            <mat-form-field class="float-left " style="width:20%;" id="goToPage">
                                <input matInput placeholder="Go to page:" type="number" min="1"
                                       [max]="numPages" [ngModel]="searchSettings.page"
                                       (ngModelChange)="pageChange({pageIndex: $event-1})">
                            </mat-form-field>
                            <mat-paginator class="float-left" (page)="pageChange($event)" [length]="totalItemsLimited"
                                           [pageIndex]="searchSettings.page - 1"
                                           [pageSize]="searchSettings.resultPerPage" [hidePageSize]="true"
                                           style="font-size: 1.4em">
                            </mat-paginator>
                            <a [hidden]="true" href="{{fakeNextPageLink()}}" rel="next">Next Page</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <ng-container #pinModal></ng-container>
</ng-template>

<ng-template #validRulesModal>
    <h3 mat-dialog-title>
        Export CDEs not passing validation rules
    </h3>
    <div mat-dialog-content>
        <p>The export will list the CDE(s) that fail registration status rules for:</p>
        <div>
            Organization:
            <mat-form-field>
                <mat-select id="selectOrg" placeholder="Organization" [(ngModel)]="validRulesOrg">
                    <mat-option *ngFor="let org of validRulesOrgs" [value]="org">{{org}}</mat-option>
                </mat-select>
            </mat-form-field>
        </div>
        <div>
            Status:
            <mat-form-field>
                <mat-select id="selectStatus" placeholder="Registration Status" [(ngModel)]="validRulesStatus">
                    <mat-option [value]="'Incomplete'">Incomplete</mat-option>
                    <mat-option [value]="'Candidate'">Candidate</mat-option>
                    <mat-option id="recorded" [value]="'Recorded'">Recorded</mat-option>
                    <mat-option [value]="'Qualified'">Qualified</mat-option>
                    <mat-option [value]="'Standard'">Standard</mat-option>
                    <mat-option [value]="'Preferred Standard'">Preferred Standard</mat-option>
                </mat-select>
            </mat-form-field>
        </div>
    </div>
    <div mat-dialog-actions>
        <button mat-raised-button color="accent" [mat-dialog-close] id="cancelCopy">Cancel</button>
        <button mat-raised-button color="primary" [mat-dialog-close]="true" id="exportVR">Export
        </button>
    </div>
</ng-template>
