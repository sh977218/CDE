<ng-container *ngIf="view === 'welcome'; then welcomeSearch else searchResults"></ng-container>

<ng-template #welcomeSearch>
    <div class="container">
        <div *ngIf="!addMode" class="forLgScreen jumbotron">
            <img [hidden]="embedded" width="364" height="118"
                 alt="NIH Common Data Elements (CDE) log" src="/cde/public/assets/img/min/NIH-CDE.svg"/>
        </div>
        <form #quickSearchForm="ngForm" id="quickSearchForm" novalidate>
            <mat-form-field style="width: 100%; font-size: 25px;">
                <input matInput name="q" id="ftsearch-input"
                       [placeholder]="'Search ' + (module === 'cde' ? 'Data Elements' : 'Forms')"
                       maxlength="500" [matAutocomplete]="auto"
                       [(ngModel)]="searchSettings.q" (ngModelChange)="searchTermAutoComplete.emit($event)">
                <div matSuffix>
                    <button type="submit" style="display: none" (click)="termSearch(true)"></button>
                    <mat-icon id="search.submit" style="line-height: .5" (click)="termSearch(true)">
                        search
                    </mat-icon>
                </div>
                <mat-hint style="font-size: 15px;">Enter keyword, classification, or topic</mat-hint>
            </mat-form-field>

            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="typeaheadSelect($event)">
                <mat-option *ngFor="let option of autocompleteSuggestions" [value]="option">
                    {{ option }}
                </mat-option>
            </mat-autocomplete>

            <!-- Error display area -->
            <p [hidden]="quickSearchForm.form.valid || quickSearchForm.form.pristine"
               class="error-block">
                <span>Query terms must be 500 characters or less.</span>
            </p>
        </form>

        <section class="row justify-content-md-center">
            <div class="col-10">
                <mat-card class="cde-bg-grey">
                    <mat-card-header>
                        <div mat-card-avatar class="d-flex align-items-center justify-content-center">
                            <img aria-label="nihEndorsed" height="40" width="40"
                                 src="/cde/public/assets/img/min/Gold-Ribbon.png">
                        </div>
                        <mat-card-title>NIH-Endorsed CDEs</mat-card-title>
                        <mat-card-subtitle>
                            <div style="float: left; max-width: 75%"> NIH has endorsed collections of CDEs that
                                meet <a href="" target="_blank">established criteria</a>.
                                NIH-Endorsed CDEs are designated with a gold ribbon. <a href="">Learn more...</a>
                            </div>
                            <button class="button" (click)="addNihEndorsedFilter(true)">
                                View NIH-Endorsed CDEs
                            </button>
                        </mat-card-subtitle>
                    </mat-card-header>
                </mat-card>
            </div>
        </section>

        <section id="tabs">
            <div *ngIf="orgs?.length === 0">
                <h1>
                    <mat-icon class="spin">auto_renew</mat-icon>
                    Searching...
                </h1>
            </div>
            <div class="responsiveGrid" style="gap: 10px 30px;">
                <div *ngFor="let org of orgs"
                     id="search_by_classification_{{org.name}}">
                    <fieldset class="cdeFieldset welcomeSearchFieldset"
                              (click)="browseOrg(org.name)">
                        <legend>
                            <span id="browseOrg-{{org.name}}" class="fake-link">{{org.name}}</span>
                        </legend>
                        <div *ngIf="org.longName">{{org.longName}}</div>
                        <div class="welcomeCount"><span id="nbOfElts-{{org.name}}">{{org.count}}</span>
                            elements
                        </div>
                        <div *ngIf="org.extraInfo">{{org.extraInfo}}</div>
                        <div *ngIf="org.uri"><a href="{{org.uri}}" target="_blank" rel="noopener noreferrer">Source</a>
                        </div>
                    </fieldset>
                    <mat-icon class="welcomeDetailIcon" *ngIf="org.htmlOverview"
                              id="search_by_classification_info_{{org.name}}" (click)="openOrgDetails(org)">
                        help_outline
                    </mat-icon>
                </div>
            </div>
        </section>
        <section>
            <span id="totalItems">{{totalItems}}</span><span> elements across all classifications</span>
            <cde-search-export-button style="margin-left: 1em; vertical-align: middle"
                                      [module]="module"
                                      (exportType)="exportService.exportSearchResults($event, module, {searchSettings: searchSettings})">
            </cde-search-export-button>
        </section>
    </div>
</ng-template>

<ng-template #orgDetailsModal>
    <div style="margin: 25px" [innerHtml]="orgHtmlOverview"></div>
</ng-template>

<ng-template #searchResults>
    <section *ngIf="elts && aggregations" class="searchResultBar">
        <form class="input-group">
            <button style="display: none" type="submit" (click)="termSearch()"></button>
            <div>
                <button class="button light secondary forNotLgScreen"
                        (click)="searchResultOptions.classList.toggle('collapse')">
                    <mat-icon>menu</mat-icon>
                </button>
            </div>
            <mat-form-field>
                <input matInput name="q" id="ftsearch-input" placeholder="Search"
                       #autoCompleteInput maxlength="500" [matAutocomplete]="auto"
                       [(ngModel)]="searchSettings.q" (ngModelChange)="searchTermAutoComplete.emit($event)">
                <mat-icon matSuffix (click)="termSearch()" id="search.submit">search</mat-icon>
            </mat-form-field>
            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="typeaheadSelect($event)">
                <mat-option *ngFor="let option of autocompleteSuggestions" [value]="option">
                    {{ option }}
                </mat-option>
            </mat-autocomplete>
        </form>
        <div #searchResultOptions>
            <button id="showHideFilters" class="button" (click)="hideShowFilter()">
                <mat-icon>filter_list</mat-icon>
                <ng-container *ngIf="!filterMode"> Show Filters</ng-container>
                <ng-container *ngIf="filterMode"> Hide Filters</ng-container>
            </button>
            <cde-list-view-controls [(listView)]="resultsView" *ngIf="!embedded"></cde-list-view-controls>
            <button *ngIf="embedded; else notEmbedButtons" id="resetSearch" class="button" (click)="reset()">
                <mat-icon>delete_outline</mat-icon>
                Reset
            </button>
            <ng-template #notEmbedButtons>
                <button id="pinAll" class="button" [hidden]="totalItems <= 0 || module === 'form'" (click)="openPinModal()">
                    <mat-icon svgIcon="thumb_tack"></mat-icon>
                    Pin All
                </button>
            </ng-template>
            <button *ngIf="!embedded" id="export" class="button" style="margin-right: 0" [matMenuTriggerFor]="exportMenu">
                <mat-icon>play_for_work</mat-icon>
                Export
                <mat-icon>arrow_drop_down</mat-icon>
            </button>
            <mat-menu #exportMenu>
                <ng-container *ngIf="userService.user || module === 'cde'; else exportFormNotAuthorized">
                    <button *ngFor="let key of ownKeys(exporters)" id="{{exporters[key].id}}" mat-menu-item
                       (click)="exportService.exportSearchResults(key, module, {searchSettings: searchSettings})"
                    >{{exporters[key].display}}</button>
                </ng-container>
                <ng-template #exportFormNotAuthorized>
                    <a mat-menu-item routerLink="/login" href="javascript:void(0);">Please login to export forms.</a>
                </ng-template>
            </mat-menu>
        </div>
    </section>
    <section *ngIf="elts && aggregations" class="mT" [class.searchFilterLayout]="filterMode">
            <div *ngIf="filterMode" style="padding-left: .25rem; padding-right: .25rem">
                <!--FILTERS-->
                <!-- NIH Endorsed AGGREGATIONS -->
                <div *ngIf="aggregations.orgs.buckets" id="nihEndorsedHolder" class="my-3">
                    <div class="treeTitle">NIH-Endorsed Collection</div>
                    <div>
                        <mat-checkbox class="example-margin" [(ngModel)]="searchSettings.nihEndorsed" color="primary"
                                      (change)="addNihEndorsedFilter($event.checked)">
                            NIH-Endorsed
                        </mat-checkbox>
                    </div>
                </div>

                <!-- CLASSIFICATION AGGREGATIONS -->
                <div *ngIf="aggregations.orgs.buckets" id="classificationListHolder">
                    <div>
                        <span class="treeTitle">Classification</span>
                        <a *ngIf="!altClassificationFilterMode && !embedded && !excludeOrgFilterMode"
                           id="altClassificationFilterModeToggle" class="hand-cursor classification-filter" style="line-height: 12px"
                           (click)="setAltClassificationFilterMode()" href="javascript:void(0);"
                           aria-label="Add a second classification filter as an AND condition"
                           matTooltip="Add a second classification filter as an AND condition"
                           matTooltipClass="cdeTooltip" matTooltipPosition="right">
                            <mat-icon>add_box</mat-icon>
                        </a>
                        <a *ngIf="!excludeOrgFilterMode && !embedded && !altClassificationFilterMode"
                           id="excludeFilterModeToggle" class="classification-filter" style="line-height: 12px"
                           (click)="setExcludeOrgFilterMode()" href="javascript:void(0);"
                           aria-label="Add a second classification filter as a NOT condition"
                           matTooltip="Add a second classification filter as a NOT condition"
                           matTooltipClass="cdeTooltip" matTooltipPosition="right">
                            <mat-icon>indeterminate_check_box</mat-icon>
                        </a>
                    </div>
                    <div *ngIf="excludeOrgFilterMode" class="treeChild hand-cursor" id="exludeAllOrgs"
                         (click)="searchExcludeAllOrgs()">
                        All (Except {{searchSettings.selectedOrg}})
                    </div>
                    <ng-container *ngFor="let t of aggregations.orgs.buckets; trackBy: trackByKey">
                        <ng-container *ngIf="getCurrentSelectedOrg(); else classifOrg">
                            <ng-container *ngIf="t.key === getCurrentSelectedOrg()">
                                <div *ngIf="getCurrentSelectedClassification()?.length; else classifSelf"
                                     id="classif-{{t.key}}" class="treeParent hand-cursor"
                                     [attr.aria-label]="t.longName" (click)="alterOrgFilter(t.key)" role="link">
                                    <mat-icon class="treeItemIcon">keyboard_arrow_left</mat-icon>
                                    <a class="treeItemText" [matTooltip]="t.longName" href="javascript:void(0);"
                                       matTooltipClass="cdeTooltip" matTooltipPosition="right"> {{t.key}}</a>
                                </div>
                                <ng-template #classifSelf>
                                    <div id="classif-{{t.key}}" class="treeCurrent treeItemText"
                                         [attr.aria-label]="t.longName">
                                        <span [matTooltip]="t.longName" matTooltipClass="cdeTooltip"
                                              matTooltipPosition="right">{{t.key}}
                                        </span>
                                    </div>
                                </ng-template>
                            </ng-container>
                        </ng-container>
                        <ng-template #classifOrg>
                            <div id="classif-{{t.key}}" class="treeChild hand-cursor" (click)="alterOrgFilter(t.key)"
                                 role="link" [attr.aria-label]="t.longName" [matTooltip]="t.longName"
                                 matTooltipClass="cdeTooltip" matTooltipPosition="right">
                                <mat-icon class="treeItemIcon">keyboard_arrow_right</mat-icon>
                                <a class="treeItemText" href="javascript:void(0);">{{t.key}} (<span
                                        id="nbOfClassifElts-{{t.key}}">{{t.doc_count}}</span>)</a>
                            </div>
                        </ng-template>
                    </ng-container>
                    <ng-container *ngFor="let e of getCurrentSelectedClassification(); index as i; last as isLast">
                        <div *ngIf="!isLast; else classifSelf2" id="classif-{{e}}" class="treeParent hand-cursor"
                             (click)="selectElement(e, 'parent', i)" role="link">
                            <mat-icon class="treeItemIcon">keyboard_arrow_left</mat-icon>
                            <a class="treeItemText" href="javascript:void(0);"> {{e}}</a>
                        </div>
                        <ng-template #classifSelf2>
                            <div id="classif-{{e}}" class="treeCurrent treeItemText"
                                 [class.treeItem]="getCurrentSelectedClassification().length">{{e}}
                            </div>
                        </ng-template>
                    </ng-container>
                    <div *ngFor="let b of getClassificationSelectedOrg(); index as i; trackBy: trackByName"
                         id="classif-{{b.name}}" class="treeChild hand-cursor"
                         [class.treeItem]="getCurrentSelectedClassification().length"
                         (click)="selectElement(b.name, 'child', i)" role="link">
                        <mat-icon class="treeItemIcon">keyboard_arrow_right</mat-icon>
                        <a class="treeItemText" href="javascript:void(0);">{{b.name}} (<span
                                id="nbOfClassifElts-{{b.name}}">{{b.count}}</span>)</a>
                    </div>
                </div>
                <!-- REGISTRATION STATUS AGGREGATION -->
                <div *ngIf="aggregations.statuses.statuses.buckets" id="registrationStatusListHolder"
                     style="margin-bottom: .75rem; margin-top: .75rem">
                    <span class="treeTitle">Registration Status</span>
                    <ng-container *ngFor="let t of aggregations.statuses.statuses.buckets">
                        <div *ngIf="t.doc_count > 0" id="regstatus-{{t.key}}" class="treeItem hand-cursor"
                             (click)="addStatusFilter(t.key)" role="link"
                             [attr.aria-label]="getRegStatusHelp(t.key)">
                            <ng-container
                                    *ngIf="searchSettings.regStatuses && searchSettings.regStatuses.indexOf(t.key) > -1; else else06">
                                <mat-icon class="filter-cb">check_box</mat-icon>
                            </ng-container>
                            <ng-template #else06>
                                <mat-icon class="filter-cb">check_box_outline_blank</mat-icon>
                            </ng-template>
                            <a class="treeItemText" [matTooltip]="getRegStatusHelp(t.key)" href="javascript:void(0);"
                               matTooltipClass="cdeTooltip" matTooltipPosition="right">{{t.key}} ({{t.doc_count}})</a>
                        </div>
                    </ng-container>
                </div>
                <!--DATA TYPE AGGREGATION-->
                <div *ngIf="module === 'cde' && aggregations.datatype.datatype.buckets.length"
                     id="datatypeListHolder" style="margin: .75rem 0">
                    <span class="treeTitle">Data Types</span>
                    <ng-container *ngFor="let t of aggregations.datatype.datatype.buckets">
                        <div *ngIf="t.doc_count > 0" id="datatype-{{t.key}}" class="treeItem hand-cursor"
                             (click)="addDatatypeFilter(t.key)" role="link">
                            <ng-container
                                    *ngIf="searchSettings.datatypes && searchSettings.datatypes.indexOf(t.key) > -1; else else07">
                                <mat-icon class="filter-cb">check_box</mat-icon>
                            </ng-container>
                            <ng-template #else07>
                                <mat-icon class="filter-cb">check_box_outline_blank</mat-icon>
                            </ng-template>
                            <a class="treeItemText" href="javascript:void(0);">{{t.key}} ({{t.doc_count}})</a>
                        </div>
                    </ng-container>
                </div>
            </div>
            <div style="padding-left: .25rem; padding-right: .25rem"
                 [style.display]="searching ? 'none' : 'block'">
                <!-- BREADCRUMBS -->
                <div *ngIf="elts && aggregations" style="margin-bottom: 1rem" id="searchResultInfoBar">
                    <strong id="searchResultNum">{{totalItems}}</strong>
                    <ng-container> {{module === 'cde' ? 'data element' : 'form'}} results for</ng-container>
                    <span *ngIf="searchSettings.nihEndorsed"
                          class="badge badge-light remove-filter hand-cursor dark-icon"
                          style="margin-left: .25rem; margin-right: .25rem"> NIH-Endorsed {{module === 'cde' ? 'CDEs' : 'Forms'}} </span>
                    <span *ngIf="searchedTerm" id="term_crumb"
                          class="badge badge-light remove-filter dark-icon fake-button" role="button" tabindex="0"
                          style="margin-left: .25rem; margin-right: .25rem"
                          aria-label="Remove this search term filter" matTooltip="Remove this search term filter"
                          matTooltipClass="cdeTooltip" matTooltipPosition="right"
                          (click)="searchSettings.q = ''; doSearch()">
                        {{searchedTerm}}
                    </span>
                    <span *ngIf="hasSelectedClassifications()" id="classif_crumb"
                          class="badge badge-light remove-filter dark-icon fake-button" role="button" tabindex="0"
                          style="margin-left: .25rem; margin-right: .25rem"
                          aria-label="Remove this classification filter" matTooltip="Remove this classification filter"
                          matTooltipClass="cdeTooltip" matTooltipPosition="right"
                          (click)="clearSelectedClassifications()">
                        {{getSelectedClassifications()}}
                    </span>
                    <ng-container *ngIf="altClassificationFilterMode">
                        and
                        <span id="classifAlt_filter" class="badge badge-light remove-filter dark-icon fake-button" role="button" tabindex="0"
                              style="padding-left: .25rem"
                              aria-label="Remove this classification filter"
                              matTooltip="Remove this classification filter"
                              matTooltipClass="cdeTooltip" matTooltipPosition="right"
                              (click)="clearSelectedClassificationsAlt()">
                            {{getSelectedClassificationsAlt()}}
                        </span>
                    </ng-container>
                    <ng-container *ngIf="excludeOrgFilterMode">
                        not
                        <span class="badge badge-light remove-filter dark-icon fake-button" role="button" tabindex="0"
                              style="padding-left: .25rem;"
                              aria-label="Remove this classification filter"
                              matTooltip="Remove this classification filter"
                              matTooltipClass="cdeTooltip" matTooltipPosition="right"
                              (click)="clearExcludeOrgs()">
                            {{getExcludedOrgs()}}
                        </span>
                    </ng-container>
                    <span *ngIf="hasSelectedStatuses()" id="status_crumb"
                          class="badge badge-light remove-filter dark-icon fake-button" role="button" tabindex="0"
                          style="margin-left: .25rem; margin-right: .25rem"
                          aria-label="Remove this registration statuses filter"
                          matTooltip="Remove this registration statuses filter"
                          matTooltipClass="cdeTooltip" matTooltipPosition="right"
                          (click)="clearSelectedStatuses()">
                        {{getSelectedStatuses()}}
                    </span>
                    <span *ngIf="module === 'cde' && hasSelectedDatatypes()" id="datatype_crumb"
                          class="badge badge-light remove-filter dark-icon fake-button" role="button" tabindex="0"
                          style="margin-left: .25rem; margin-right: .25rem"
                          aria-label="Remove this datatype filter"
                          matTooltip="Remove this datatype filter"
                          matTooltipClass="cdeTooltip" matTooltipPosition="right"
                          (click)="clearSelectedDatatypes()">
                        {{getSelectedDatatypes()}}
                    </span>
                    <a (click)="reset()" href="javascript:void(0);" style="font-size: small">Clear All</a>
                    <small> ({{took / 1000}} secs)</small>
                </div>
                <!-- SEARCH RESULTS -->
                <div id="resultList">
                    <div id="resultListTour"></div>
                    <h1 [hidden]="elts.length >= 0">
                        <mat-icon class="spin">auto_renew</mat-icon>Searching...</h1>
                    <h2 [hidden]="elts.length !== 0"><mat-icon>sentiment_very_dissatisfied</mat-icon>
                        No results were found. Try other criterias or selecting more statuses</h2>
                    <cde-list-view [elts]="elts" [embedded]="embedded" [module]="module" [(listView)]="resultsView"
                                   (add)="add.emit($event)"></cde-list-view>
                    <div>
                        <div style="float: right">
                            <mat-form-field style="width:20%;" id="goToPage">
                                <input matInput placeholder="Go to page:" type="number" min="1"
                                       [max]="numPages" [ngModel]="searchSettings.page"
                                       (ngModelChange)="pageChange({pageIndex: $event-1})">
                            </mat-form-field>
                            <mat-paginator (page)="pageChange($event)" [length]="totalItemsLimited"
                                           [pageIndex]="searchSettings.page - 1"
                                           [pageSize]="searchSettings.resultPerPage" [hidePageSize]="true"
                                           style="float: right; font-size: 1.4em">
                            </mat-paginator>
                            <a [hidden]="true" href="{{fakeNextPageLink()}}" rel="next">Next Page</a>
                        </div>
                    </div>
                </div>
            </div>
    </section>
    <ng-container #pinModal></ng-container>
</ng-template>
