<div ng-controller="CommentsCtrl">
    <br/>
    <div tabindex="0" ng-if="!user._id">Please <a tabindex="0" href="/login">log in</a> to comment.</div>
    <div ng-if="user._id">
        <form role="form" name="commentForm" id="commentForm" novalidate>
            <label tabindex="0" class="sr-only" for="commentTextArea">Comments</label>
            <textarea tabindex="0" name="commentTextArea" id="commentTextArea" class="form-control" rows="3"
                      ng-model="newComment.content" placeholder="Join the discussion..." required></textarea>
            <input tabindex="0" name="postComment" id="postComment" class="btn btn-primary" type="button"
                   value="Post Comment" ng-click="addComment()" ng-disabled="commentForm.commentTextArea.$invalid"/>
        </form>
    </div>
    <br/>


    <div class="comment" id="comment_{{commentIndex}}" ng-class="{currentTabComment:currentTab === comment.linkedTab}"
         ng-repeat="(commentIndex, comment) in eltComments">
        <div ng-if="tabs[comment.linkedTab].active" class="comment-arrow-outer"></div>
        <div ng-if="tabs[comment.linkedTab].active" class="comment-arrow-inner"></div>
        <div class="rootComment">
            <div class="commentBody">
                <div class="commentHeader">
                    <table style="width: 100%;">
                        <tbody>
                        <tr>
                            <td>
                                <img ng-src="{{avatarUrls[comment.username.toLowerCase()]}}" width="32" height="32"
                                     alt="portrait"/>
                            </td>
                            <td>
                                <div>
                                    <div>
                                        <div>{{comment.username}}</div>
                                        <div>
                                            {{comment.created | date: 'MM/dd/yyyy @ h:mma'}}
                                        </div>

                                    </div>
                                </div>
                            </td>
                            <td>
                                <i class="fa fa-trash-o hand-cursor" title="Remove"
                                   id="removeComment-{{commentIndex}}"
                                   ng-show="canRemoveComment(comment)"
                                   ng-click="removeComment(comment._id)" data-type="remove"></i>
                                <i class="fa fa-check-circle-o hand-cursor" title="Resolve"
                                   id="resolveComment-{{commentIndex}}"
                                   ng-show="canResolveComment(comment)"
                                   ng-click="updateCommentStatus(comment._id, 'resolved')"></i>
                                <i class="fa fa-undo hand-cursor" title="Reopen"
                                   id="reopenComment-{{commentIndex}}"
                                   ng-show="canReopenComment(comment)"
                                   ng-click="updateCommentStatus(comment._id, 'active')"></i>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div id="commentText-{{commentIndex}}" class="commentMessage"
                     ng-class="{strike: comment.status === 'resolved'}">{{comment.text}}
                </div>
            </div>
        </div>
        <div ng-repeat="(replyIndex, reply) in comment.replies" data-type="replyComment">
            <div ng-if="showAllReplies[comment._id] || comment.replies.length <= 5">
                <div class="reply">
                    <div class="commentHeader">
                        <table style="width: 100%;">
                            <tbody>
                            <tr>
                                <td>
                                    <img ng-src="{{avatarUrls[reply.username.toLowerCase()]}}" width="32" height="32"
                                         alt="portrait"/>
                                </td>
                                <td>
                                    <div>
                                        <div>
                                            <div>{{reply.username}}</div>
                                            <div>
                                                {{reply.created | date: 'MM/dd/yyyy @ h:mma'}}
                                            </div>

                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <i class="fa fa-trash-o hand-cursor" title="Remove"
                                       id="removeReply-{{commentIndex}}-{{replyIndex}}"
                                       ng-show="canRemoveComment(reply)"
                                       ng-click="removeComment(comment._id, reply._id)" data-type="remove"></i>
                                    <i class="fa fa-check-circle-o hand-cursor" title="Resolve"
                                       id="resolveReply-{{commentIndex}}-{{replyIndex}}"
                                       ng-show="canResolveComment(reply)"
                                       ng-click="updateReplyStatus(comment._id, reply._id, 'resolved')"
                                       data-type="resolve"></i>
                                    <i class="fa fa-undo hand-cursor" title="Reopen"
                                       id="reopenReply-{{commentIndex}}-{{replyIndex}}"
                                       ng-show="canReopenComment(reply)"
                                       ng-click="updateReplyStatus(comment._id, reply._id, 'active')"
                                       data-type="reopen"></i>

                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="replyText-{{commentIndex}}" class="commentMessage"
                         ng-class="{strike: reply.status === 'resolved'}">
                        {{reply.text}}
                    </div>
                </div>
            </div>
            <div ng-if="!(showAllReplies[comment._id] || comment.replies.length <= 5)">
                <div ng-if="replyIndex < 2">
                    <div class="reply">
                        <div class="commentHeader">
                            <table style="width: 100%;">
                                <tbody>
                                <tr>
                                    <td>
                                        <img ng-src="{{avatarUrls[reply.username]}}" width="32" height="32"
                                             alt="portrait"/>
                                    </td>
                                    <td>
                                        <div>
                                            <div>
                                                <div>{{reply.username}}</div>
                                                <div>
                                                    {{reply.created | date: 'MM/dd/yyyy @ h:mma'}}
                                                </div>

                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <i class="fa fa-trash-o hand-cursor" title="Remove"
                                           id="removeReply-{{commentIndex}}-{{replyIndex}}"
                                           ng-show="canRemoveComment(reply)"
                                           ng-click="removeComment(reply._id)" data-type="remove"></i>
                                        <i class="fa fa-check-circle-o hand-cursor" title="Resolve"
                                           id="resolveReply-{{commentIndex}}-{{replyIndex}}"
                                           ng-show="canResolveComment(reply)"
                                           ng-click="updateCommentStatus(reply._id, 'resolved')"
                                           data-type="resolve"></i>
                                        <i class="fa fa-undo hand-cursor" title="Reopen"
                                           id="reopenReply-{{commentIndex}}-{{replyIndex}}"
                                           ng-show="canReopenComment(reply)"
                                           ng-click="updateCommentStatus(reply._id, 'active')"
                                           data-type="reopen"></i>

                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="replyText-{{commentIndex}}" class="commentMessage"
                             ng-class="{strike: reply.status === 'resolved'}">
                            {{reply.text}}
                        </div>
                    </div>
                </div>
                <div class="showRepliesButtonDiv"
                     ng-if="!showAllReplies[comment._id] && replyIndex === 3 && replyIndex >= 2 && replyIndex < comment.replies.length - 2">
                    <a class="showRepliesButton" id="showAllRepliesButton-{{commentIndex}}-{{replyIndex}}"
                         ng-click="showAllReplies[comment._id] = true" href="">
                        Show all {{comment.replies.length}} replies
                    </a>
                </div>
                <div ng-if="replyIndex >= comment.replies.length - 2">
                    <div class="reply">
                        <div class="commentHeader">
                            <table style="width: 100%;">
                                <tbody>
                                <tr>
                                    <td>
                                        <img ng-src="{{avatarUrls[reply.username]}}" width="32" height="32"
                                             alt="portrait"/>
                                    </td>
                                    <td>
                                        <div>
                                            <div>
                                                <div>{{reply.username}}</div>
                                                <div>
                                                    {{reply.created | date: 'MM/dd/yyyy @ h:mma'}}
                                                </div>

                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <i class="fa fa-trash-o hand-cursor" title="Remove" id="removeReply-{{commentIndex}}"
                                           ng-show="canRemoveComment(reply)"
                                           ng-click="removeComment(reply._id)" data-type="remove"></i>
                                        <i class="fa fa-check-circle-o hand-cursor" title="Resolve"
                                           id="resolveReply-{{commentIndex}}"
                                           ng-show="canResolveComment(reply)"
                                           ng-click="updateCommentStatus(reply._id, 'resolved')"
                                           data-type="resolve"></i>
                                        <i class="fa fa-undo hand-cursor" title="Reopen" id="reopenReply-{{commentIndex}}"
                                           ng-show="canReopenComment(reply)"
                                           ng-click="updateCommentStatus(reply._id, 'active')"
                                           data-type="reopen"></i>

                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="replyText-{{commentIndex}}" class="commentMessage"
                             ng-class="{strike: reply.status === 'resolved'}">
                            {{reply.text}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <span class="replying padding10" ng-show="comment.currentReplying">Someone is typing</span>
        <div data-type="reply" class="replyInputDiv" ng-if="user._id">
            <textarea class="replyInputTextarea" id="replyTextarea_{{commentIndex}}" name="replyTextArea"
                      rows="1" msd-elastic ng-model="tempReplies[comment._id]"
                      placeholder="Reply to this comment" ng-change="changeOnReply(comment)">
            </textarea>
            <div class="replyInputBtn" ng-show="tempReplies[comment._id].length > 0" style="margin-top: 10px">
                <button ng-click="replyTo(comment._id, tempReplies[comment._id])" style="margin-left: 0"
                        class="btn btn-primary" id="replyBtn_{{commentIndex}}">Reply
                </button>
                <button ng-click="cancelReply(comment);" class="btn btn-default">Cancel</button>
            </div>
        </div>
    </div>
</div>
